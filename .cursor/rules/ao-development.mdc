---
name: "AO Development Best Practices"
description: "Specific rules and constraints for AO blockchain development"
type: "auto-attached"
version: "1.0.0"
created: "2025-10-20"
updated: "2025-10-20"
tags: ["ao", "blockchain", "lua", "async", "serialization"]
globs: ["src/**/*.lua", "**/*.lua"]
priority: 8
---

# AO å¼€å‘æœ€ä½³å®è·µè§„åˆ™

## ğŸ”’ åºåˆ—åŒ–å®‰å…¨è§„åˆ™

### æ¶ˆæ¯æ•°æ®ç±»å‹é™åˆ¶
- **ç¦æ­¢ä½¿ç”¨**: `userdata` ç±»å‹ (å¦‚ `bint` å¯¹è±¡) ç›´æ¥ä½œä¸ºæ¶ˆæ¯æ•°æ®
- **æ¨èä½¿ç”¨**: `string`, `number`, `boolean`, `table` (åŒ…å«åŸºæœ¬ç±»å‹)
- **åºåˆ—åŒ–æ–¹æ³•**: æ‰€æœ‰æ¶ˆæ¯æ•°æ®å¿…é¡»å¯è¢« `json.encode()` å¤„ç†

```lua
-- âŒ é”™è¯¯ç¤ºä¾‹
Send({
    Target = target,
    Quantity = bint("1000")  -- bint å¯¹è±¡æ— æ³•åºåˆ—åŒ–
})

-- âœ… æ­£ç¡®ç¤ºä¾‹
Send({
    Target = target,
    Quantity = "1000"  -- ä½¿ç”¨å­—ç¬¦ä¸²
})
```

### æ•°å€¼å¤„ç†è§„èŒƒ
- **ä¼ è¾“æ ¼å¼**: æ‰€æœ‰æ•°å€¼åœ¨è¿›ç¨‹é—´ä¼ é€’æ—¶ä½¿ç”¨å­—ç¬¦ä¸²æ ¼å¼
- **è®¡ç®—æ ¼å¼**: å†…éƒ¨è®¡ç®—æ—¶å°†å­—ç¬¦ä¸²è½¬æ¢ä¸º `bint` å¯¹è±¡
- **å­˜å‚¨æ ¼å¼**: çŠ¶æ€æ•°æ®ä»¥å­—ç¬¦ä¸²æ ¼å¼æŒä¹…åŒ–

```lua
-- æ ‡å‡†æ•°å€¼å¤„ç†æ¨¡å¼
local function transfer_tokens(from, to, amount_str)
    -- 1. å­—ç¬¦ä¸²è¾“å…¥éªŒè¯
    assert(type(amount_str) == 'string', 'Amount must be string')

    -- 2. è½¬æ¢ä¸º bint è¿›è¡Œè®¡ç®—
    local amount = bint(amount_str)
    local balance = bint(Balances[from])

    -- 3. æ‰§è¡Œè®¡ç®—
    if amount <= balance then
        -- 4. ç»“æœè½¬å›å­—ç¬¦ä¸²å­˜å‚¨
        Balances[from] = tostring(balance - amount)
        Balances[to] = tostring(bint(Balances[to]) + amount)
    end
end
```

## ğŸ—ï¸ å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼

### Handler æ³¨å†Œè§„èŒƒ
- **ç»Ÿä¸€æ ¼å¼**: ä½¿ç”¨ `Handlers.utils.hasMatchingTag()` è¿›è¡Œæ¶ˆæ¯è¿‡æ»¤
- **é”™è¯¯å¤„ç†**: æ‰€æœ‰ handler å¿…é¡»ä½¿ç”¨ `pcall` åŒ…è£…ä¸šåŠ¡é€»è¾‘
- **å“åº”æœºåˆ¶**: ä½¿ç”¨ `messaging.respond()` å‘é€å“åº”

```lua
-- æ ‡å‡† Handler æ ¼å¼
Handlers.add(
    "transfer_handler",
    Handlers.utils.hasMatchingTag("Action", "Transfer"),
    function(msg)
        local status, result = pcall(function()
            -- ä¸šåŠ¡é€»è¾‘å®ç°
            return process_transfer(msg)
        end)

        messaging.respond(status, result, msg)
    end
)
```

### Saga äº‹åŠ¡æ¨¡å¼
- **æ­¥éª¤å‡½æ•°**: æ¯ä¸ªæ­¥éª¤è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œæ¥å— `commit` å‚æ•°
- **æ¡ä»¶æ‰§è¡Œ**: åªæœ‰åœ¨ `commit` ä¸º `true` æ—¶æ‰ä¿®æ”¹çŠ¶æ€
- **é”™è¯¯å¤„ç†**: å¤±è´¥æ—¶è¿”å›é”™è¯¯ä¿¡æ¯ï¼Œä¸ä¿®æ”¹çŠ¶æ€

```lua
-- æ­£ç¡®çš„ Saga æ­¥éª¤å®ç°
function saga_step_create_order(context)
    return function(commit)
        if commit then
            -- åªæœ‰åœ¨ commit æ—¶æ‰çœŸæ­£åˆ›å»ºè®¢å•
            Orders[order_id] = order_data
            context.order_created = true
        end
        return {order_id = order_id}
    end
end
```

## ğŸ”‘ Table Key å®‰å…¨è§„åˆ™

### å…è®¸çš„ Key ç±»å‹
- âœ… **å­—ç¬¦ä¸² (string)**: `"user_123"`, `"order_456"`
- âœ… **æ•°å­— (number)**: `123`, `456.789`
- âœ… **å¸ƒå°”å€¼ (boolean)**: `true`, `false`

### ç¦æ­¢çš„ Key ç±»å‹
- âŒ **Table**: `{id = 123}` - ä½¿ç”¨å¼•ç”¨åˆ¤ç­‰
- âŒ **Function**: æ¯æ¬¡åˆ›å»ºéƒ½æ˜¯æ–°å®ä¾‹
- âŒ **Userdata**: ä¾èµ–å…·ä½“å®ç°

### å¤åˆ Key è§£å†³æ–¹æ¡ˆ
```lua
-- âŒ ä¸å®‰å…¨çš„åšæ³•
local item_id = {product_id = 123, location = "A1"}
InventoryTable[item_id] = data  -- å¼•ç”¨åˆ¤ç­‰é—®é¢˜

-- âœ… å®‰å…¨çš„åšæ³•
local key = json.encode({
    product_id = 123,
    location = "A1"
})
InventoryTable[key] = data  -- å­—ç¬¦ä¸² keyï¼Œç¡®ä¿ä¸€è‡´æ€§
```

## ğŸ“¦ æ¨¡å—åŒ–å¼€å‘è§„èŒƒ

### æ–‡ä»¶èŒè´£åˆ†ç¦»
- **è‡ªåŠ¨ç”Ÿæˆæ–‡ä»¶**: `*_aggregate.lua`, `*_main.lua` - ä¸å¯ä¿®æ”¹
- **ä¸šåŠ¡é€»è¾‘æ–‡ä»¶**: `*_logic.lua` - ä»…ä¿®æ”¹è¿™äº›æ–‡ä»¶
- **é…ç½®æ–‡**: `*_config.lua` - ç¯å¢ƒç‰¹å®šé…ç½®

### ä¾èµ–ç®¡ç†
- **æ˜¾å¼å¯¼å…¥**: ä½¿ç”¨ `require()` æ˜¾å¼å£°æ˜ä¾èµ–
- **ç›¸å¯¹è·¯å¾„**: å¼€å‘ç¯å¢ƒä½¿ç”¨ç›¸å¯¹è·¯å¾„
- **æ¨¡å—éš”ç¦»**: ä¸åŒè¿›ç¨‹çš„ä»£ç åœ¨ç‹¬ç«‹è¿è¡Œæ—¶ä¸­æ‰§è¡Œ

## ğŸ§ª æµ‹è¯•å’Œè°ƒè¯•è§„èŒƒ

### è¿›ç¨‹å‘½åçº¦å®š
```bash
# å¼€å‘ç¯å¢ƒ
aos process_alice    # ä¸»æµ‹è¯•è¿›ç¨‹
aos process_bob      # ä»æµ‹è¯•è¿›ç¨‹

# ç”Ÿäº§ç¯å¢ƒ
aos process_inventory_item    # åº“å­˜èšåˆè¿›ç¨‹
aos process_inventory_service # åº“å­˜æœåŠ¡è¿›ç¨‹
aos process_blog             # åšå®¢è¿›ç¨‹
```

### è°ƒè¯•å‘½ä»¤
```lua
-- æŸ¥çœ‹æœ€æ–°æ¶ˆæ¯
Inbox[#Inbox]

-- æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
print("Process ID:", ao.id)
print("Loaded modules:", _G)

-- å‘é€æµ‹è¯•æ¶ˆæ¯
Send({
    Target = "PROCESS_ID",
    Action = "TestAction",
    Data = json.encode({test = "data"})
})
```

## ğŸš¨ å¸¸è§é™·é˜±æé†’

### å¼‚æ­¥æ‰§è¡Œé™·é˜±
- **é—®é¢˜**: åœ¨å¼‚æ­¥æ“ä½œä¸­ç›´æ¥ä¿®æ”¹å…±äº«çŠ¶æ€
- **åæœ**: ç«æ€æ¡ä»¶ï¼Œæ•°æ®ä¸ä¸€è‡´
- **è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨ Saga æ¨¡å¼ç¡®ä¿äº‹åŠ¡æ€§

### åºåˆ—åŒ–å¤±è´¥
- **é—®é¢˜**: å‘é€åŒ…å« `userdata` çš„æ¶ˆæ¯
- **åæœ**: æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œè¿›ç¨‹å´©æºƒ
- **è§£å†³æ–¹æ¡ˆ**: æ‰€æœ‰ä¼ è¾“æ•°æ®è½¬æ¢ä¸ºåŸºæœ¬ç±»å‹

### å†…å­˜æ³„æ¼
- **é—®é¢˜**: åœ¨å…¨å±€ table ä¸­ç´¯ç§¯å¤§é‡æ•°æ®
- **åæœ**: è¿›ç¨‹å†…å­˜æº¢å‡ºï¼Œæ€§èƒ½ä¸‹é™
- **è§£å†³æ–¹æ¡ˆ**: å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®ï¼Œå®ç°æ•°æ®æ¸…ç†ç­–ç•¥

---

*éµå¾ªè¿™äº›è§„åˆ™å¯ä»¥ç¡®ä¿ AO åº”ç”¨çš„å¯é æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚*