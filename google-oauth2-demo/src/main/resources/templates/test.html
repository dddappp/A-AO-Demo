<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 
        === CSRF Token å…ƒæ•°æ®é…ç½® ===
        
        ä»€ä¹ˆæ˜¯CSRF Tokenï¼Ÿ
        - CSRF Tokenæ˜¯æœåŠ¡å™¨ç”Ÿæˆçš„éšæœºå­—ç¬¦ä¸²ï¼Œç”¨äºéªŒè¯è¯·æ±‚çš„åˆæ³•æ€§
        - æ¯ä¸ªç”¨æˆ·ä¼šè¯éƒ½æœ‰å”¯ä¸€çš„CSRF Token
        - æ¶æ„ç½‘ç«™æ— æ³•è·å–åˆ°è¿™ä¸ªTokenï¼Œå› æ­¤æ— æ³•ä¼ªé€ è¯·æ±‚
        
        è¿™é‡Œé€šè¿‡Thymeleafæ¨¡æ¿å¼•æ“å°†æœåŠ¡å™¨ç”Ÿæˆçš„CSRF Tokenå’ŒHeaderåç§°
        åµŒå…¥åˆ°HTMLçš„metaæ ‡ç­¾ä¸­ï¼Œæ–¹ä¾¿JavaScriptè·å–å’Œä½¿ç”¨
        
        _csrf.token: å®é™…çš„CSRF Tokenå€¼ (ä¾‹å¦‚: "a1b2c3d4-e5f6-7890...")
        _csrf.headerName: HTTPè¯·æ±‚å¤´åç§° (é€šå¸¸æ˜¯: "X-XSRF-TOKEN")
    -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>OAuth2 Demo - æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .frontend-badge {
            background: #28a745;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .user-info {
            background-color: #e8f5e8;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 30px;
            border-left: 4px solid #4CAF50;
        }
        .user-info h2 {
            color: #2e7d32;
            margin-top: 0;
        }
        .user-info p {
            margin: 8px 0;
            color: #333;
        }
        .button {
            background-color: #2196F3;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
            transition: background-color 0.3s;
        }
        .button:hover {
            background-color: #1976D2;
        }
        .button.danger {
            background-color: #f44336;
        }
        .button.danger:hover {
            background-color: #d32f2f;
        }
        .result {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            border-left: 4px solid #4CAF50;
            background-color: #e8f5e8;
        }
        .error {
            border-left: 4px solid #f44336;
            background-color: #ffebee;
        }
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }
        .actions {
            text-align: center;
            margin: 30px 0;
        }
        .logout-link {
            color: #f44336;
            text-decoration: none;
            font-size: 14px;
        }
        .logout-link:hover {
            text-decoration: underline;
        }
        .avatar-section {
            margin-top: 15px;
        }
        .avatar-section img {
            margin-top: 5px;
        }
        .github-info {
            margin-top: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 3px solid #24292e;
        }
        .github-info a {
            color: #0366d6;
            text-decoration: none;
        }
        .github-info a:hover {
            text-decoration: underline;
        }
        .provider-info {
            background-color: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="frontend-badge">
            ğŸ“„ å½“å‰ä½¿ç”¨ï¼šThymeleaf å‰ç«¯å®ç° (Server-Side Rendering)
        </div>
        <h1>OAuth2 ID Token éªŒè¯æµ‹è¯•</h1>

        <!-- æ˜¾ç¤ºå½“å‰ç™»å½•çš„æä¾›å•† -->
        <div class="provider-info">
            <p><strong>ç™»å½•æä¾›å•†ï¼š</strong><span th:text="${provider}">æœªçŸ¥</span></p>
        </div>

        <div class="user-info">
            <h2>ç”¨æˆ·ä¿¡æ¯</h2>
            <!-- æ ¹æ®æä¾›å•†æ˜¾ç¤ºä¸åŒå­—æ®µ -->
            <p><strong>ç”¨æˆ·åï¼š</strong><span th:text="${userName}">æœªçŸ¥</span></p>
            <p><strong>é‚®ç®±ï¼š</strong><span th:text="${userEmail != null ? userEmail : 'æœªæä¾›'}">æœªçŸ¥</span></p>
            <p><strong>ç”¨æˆ·IDï¼š</strong><span th:text="${userId}">æœªçŸ¥</span></p>
            <!-- æ˜¾ç¤ºå¤´åƒï¼ˆå¦‚æœæœ‰ï¼‰ -->
            <div th:if="${userAvatar}" class="avatar-section">
                <p><strong>å¤´åƒï¼š</strong></p>
                <img th:src="${userAvatar}" alt="ç”¨æˆ·å¤´åƒ" style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid #ddd;">
            </div>

            <!-- GitHubç‰¹å®šä¿¡æ¯ -->
            <div th:if="${provider == 'github'}" class="github-info">
                <p><strong>GitHubä¸»é¡µï¼š</strong><a th:href="${userHtmlUrl}" th:text="${userHtmlUrl}" target="_blank">æŸ¥çœ‹GitHub</a></p>
                <p><strong>å…¬å¼€ä»“åº“æ•°ï¼š</strong><span th:text="${userPublicRepos}">æœªçŸ¥</span></p>
                <p><strong>ç²‰ä¸æ•°ï¼š</strong><span th:text="${userFollowers}">æœªçŸ¥</span></p>
            </div>

            <!-- Twitterç‰¹å®šä¿¡æ¯ -->
            <div th:if="${provider == 'twitter'}" class="github-info" style="border-left-color: #1da1f2;">
                <p><strong>Xä¸»é¡µï¼š</strong><a th:href="'https://x.com/' + ${userId}" th:text="'@' + ${userId}" target="_blank">æŸ¥çœ‹X</a></p>
                <p><strong>ä½ç½®ï¼š</strong><span th:text="${userLocation != null ? userLocation : 'æœªè®¾ç½®'}">æœªçŸ¥</span></p>
                <p><strong>æ˜¯å¦å·²éªŒè¯ï¼š</strong><span th:text="${userVerified ? 'æ˜¯' : 'å¦'}">æœªçŸ¥</span></p>
                <p><strong>ä¸ªäººç®€ä»‹ï¼š</strong><span th:text="${userDescription != null ? userDescription : 'æš‚æ— ç®€ä»‹'}">æš‚æ— ç®€ä»‹</span></p>
            </div>
        </div>

        <div class="actions">
            <!-- æ ¹æ®æä¾›å•†æ˜¾ç¤ºä¸åŒçš„éªŒè¯æŒ‰é’® -->
            <button id="validateBtn" th:if="${provider == 'google'}" class="button">éªŒè¯ Google ID Token</button>
            <button id="validateGitHubBtn" th:if="${provider == 'github'}" class="button">éªŒè¯ GitHub è®¿é—®ä»¤ç‰Œ</button>
            <button id="validateTwitterBtn" th:if="${provider == 'twitter'}" class="button">éªŒè¯ Twitter è®¿é—®ä»¤ç‰Œ</button>
            <a href="/logout" class="logout-link">ç™»å‡º</a>
        </div>

        <!-- æ‰‹åŠ¨éªŒè¯åŒºåŸŸ -->
        <div id="manualValidationSection" style="display: none; margin-top: 20px;">
            <h3>æ‰‹åŠ¨ JWT Token éªŒè¯</h3>
            <textarea id="jwtTokenInput" placeholder="ç²˜è´´æ‚¨çš„ JWT Token è¿™é‡Œ..." rows="4" style="width: 100%; padding: 10px; margin: 10px 0; font-family: monospace;"></textarea>
            <button id="submitManualValidation" class="button">éªŒè¯ Token</button>
        </div>

        <div id="resultContainer" style="display: none;">
            <h3>éªŒè¯ç»“æœ</h3>
            <div id="result" class="result"></div>
        </div>
    </div>

    <script>
        // å…¨å±€é”™è¯¯å¤„ç†å™¨
        window.addEventListener('error', function(e) {
            console.error('JavaScripté”™è¯¯:', e.error);
            console.error('é”™è¯¯æ–‡ä»¶:', e.filename);
            console.error('é”™è¯¯è¡Œå·:', e.lineno);
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', e.reason);
        });

        console.log('é¡µé¢åŠ è½½ï¼Œå¼€å§‹åˆå§‹åŒ–JavaScript...');

        // ç¡®ä¿DOMåŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹ç»‘å®šäº‹ä»¶ç›‘å¬å™¨...');

            // åœ¨DOMåŠ è½½å®Œæˆåé‡æ–°æ£€æŸ¥GitHubæŒ‰é’®
            setTimeout(function() {
                console.log('å»¶è¿Ÿæ£€æŸ¥GitHubæŒ‰é’®...');
                const githubBtn = document.getElementById('validateGitHubBtn');
                console.log('å»¶è¿Ÿæ£€æŸ¥ - GitHubæŒ‰é’®å…ƒç´ :', githubBtn);
                if (githubBtn) {
                    console.log('å»¶è¿Ÿç»‘å®š - GitHubéªŒè¯æŒ‰é’®å·²æ‰¾åˆ°ï¼Œæ·»åŠ äº‹ä»¶ç›‘å¬å™¨');
                    githubBtn.addEventListener('click', function() {
                        console.log('GitHubéªŒè¯æŒ‰é’®è¢«ç‚¹å‡» (å»¶è¿Ÿç»‘å®š)');
                        const resultContainer = document.getElementById('resultContainer');
                        const resultDiv = document.getElementById('result');

                        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                        resultContainer.style.display = 'block';
                        resultDiv.className = 'result loading';
                        resultDiv.textContent = 'æ­£åœ¨éªŒè¯ GitHub è®¿é—®ä»¤ç‰Œ...';

                        // GitHubè®¿é—®ä»¤ç‰Œç°åœ¨è‡ªåŠ¨å­˜å‚¨åœ¨HttpOnly Cookieä¸­
                        // åç«¯ä¼šä»cookieä¸­å®‰å…¨è·å–ä»¤ç‰Œè¿›è¡ŒéªŒè¯
                        // è¿™æ ·æ—¢å®‰å…¨åˆæ–¹ä¾¿ç”¨æˆ·ä½¿ç”¨

                        console.log('å‡†å¤‡éªŒè¯GitHubè®¿é—®ä»¤ç‰Œï¼ˆä»cookieè‡ªåŠ¨è·å–ï¼‰');

                        // å‘é€éªŒè¯è¯·æ±‚
                        const headers = {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        };
                        headers[getCsrfHeader()] = getCsrfToken();

                        console.log('å‘é€GitHubéªŒè¯è¯·æ±‚åˆ° /api/validate-github-token (å»¶è¿Ÿç»‘å®š)');
                        console.log('CSRF Header:', getCsrfHeader());
                        console.log('CSRF Token:', getCsrfToken() ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®');

                fetch('/api/validate-github-token', {
                    method: 'POST',
                    headers: headers
                })
                        .then(response => {
                            console.log('æ”¶åˆ°å“åº”ï¼ŒçŠ¶æ€ç :', response.status);
                            return response.json();
                        })
                        .then(data => {
                            console.log('å“åº”æ•°æ®:', data);
                            if (data.success) {
                                resultDiv.className = 'result success';
                                resultDiv.textContent = 'âœ… GitHubéªŒè¯æˆåŠŸ!\n\n' + JSON.stringify(data.validation, null, 2);
                            } else {
                                resultDiv.className = 'result error';
                                resultDiv.textContent = 'âŒ GitHubéªŒè¯å¤±è´¥: ' + data.message;
                            }
                        })
                        .catch(error => {
                            resultDiv.className = 'result error';
                            resultDiv.textContent = 'âŒ è¯·æ±‚å¤±è´¥: ' + error.message;
                            console.error('Error:', error);
                        });
                    });
                } else {
                    console.log('GitHubéªŒè¯æŒ‰é’®ä¸å­˜åœ¨ï¼Œå¯èƒ½ç”¨æˆ·ä¸æ˜¯é€šè¿‡GitHubç™»å½•çš„');
                }

                // åœ¨DOMåŠ è½½å®Œæˆåé‡æ–°æ£€æŸ¥TwitteræŒ‰é’®
                console.log('å»¶è¿Ÿæ£€æŸ¥TwitteræŒ‰é’®...');
                const twitterBtn = document.getElementById('validateTwitterBtn');
                console.log('å»¶è¿Ÿæ£€æŸ¥ - TwitteræŒ‰é’®å…ƒç´ :', twitterBtn);
                if (twitterBtn) {
                    console.log('å»¶è¿Ÿç»‘å®š - TwitteréªŒè¯æŒ‰é’®å·²æ‰¾åˆ°ï¼Œæ·»åŠ äº‹ä»¶ç›‘å¬å™¨');
                    twitterBtn.addEventListener('click', function() {
                        console.log('TwitteréªŒè¯æŒ‰é’®è¢«ç‚¹å‡» (å»¶è¿Ÿç»‘å®š)');
                        const resultContainer = document.getElementById('resultContainer');
                        const resultDiv = document.getElementById('result');

                        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                        resultContainer.style.display = 'block';
                        resultDiv.className = 'result loading';
                        resultDiv.textContent = 'æ­£åœ¨éªŒè¯ Twitter è®¿é—®ä»¤ç‰Œ...';

                        // Twitterè®¿é—®ä»¤ç‰Œç°åœ¨è‡ªåŠ¨å­˜å‚¨åœ¨HttpOnly Cookieä¸­
                        // åç«¯ä¼šä»cookieä¸­å®‰å…¨è·å–ä»¤ç‰Œè¿›è¡ŒéªŒè¯
                        // è¿™æ ·æ—¢å®‰å…¨åˆæ–¹ä¾¿ç”¨æˆ·ä½¿ç”¨

                        console.log('å‡†å¤‡éªŒè¯Twitterè®¿é—®ä»¤ç‰Œï¼ˆä»cookieè‡ªåŠ¨è·å–ï¼‰');

                        // å‘é€éªŒè¯è¯·æ±‚
                        const headers = {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        };
                        headers[getCsrfHeader()] = getCsrfToken();

                        console.log('å‘é€XéªŒè¯è¯·æ±‚åˆ° /api/validate-x-token (å»¶è¿Ÿç»‘å®š)');
                        console.log('CSRF Header:', getCsrfHeader());
                        console.log('CSRF Token:', getCsrfToken() ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®');

                        fetch('/api/validate-x-token', {
                            method: 'POST',
                            headers: headers
                        })
                        .then(response => {
                            console.log('æ”¶åˆ°å“åº”ï¼ŒçŠ¶æ€ç :', response.status);
                            return response.json();
                        })
                        .then(data => {
                            console.log('å“åº”æ•°æ®:', data);
                            if (data.success) {
                                resultDiv.className = 'result success';
                                resultDiv.textContent = 'âœ… TwitteréªŒè¯æˆåŠŸ!\n\n' + JSON.stringify(data.validation, null, 2);
                            } else {
                                resultDiv.className = 'result error';
                                resultDiv.textContent = 'âŒ TwitteréªŒè¯å¤±è´¥: ' + data.message;
                            }
                        })
                        .catch(error => {
                            resultDiv.className = 'result error';
                            resultDiv.textContent = 'âŒ è¯·æ±‚å¤±è´¥: ' + error.message;
                            console.error('Error:', error);
                        });
                    });
                } else {
                    console.log('TwitteréªŒè¯æŒ‰é’®ä¸å­˜åœ¨ï¼Œå¯èƒ½ç”¨æˆ·ä¸æ˜¯é€šè¿‡Twitterç™»å½•çš„');
                }
            }, 100); // çŸ­æš‚å»¶è¿Ÿç¡®ä¿Thymeleafæ¡ä»¶æ¸²æŸ“å®Œæˆ
        });

        /*
         * === å‰ç«¯CSRFä¿æŠ¤æœºåˆ¶ ===
         * 
         * ä¸ºä»€ä¹ˆå‰ç«¯éœ€è¦å¤„ç†CSRF Tokenï¼Ÿ
         * - ç°ä»£Webåº”ç”¨å¤§é‡ä½¿ç”¨AJAX/Fetchè¿›è¡Œå¼‚æ­¥è¯·æ±‚
         * - æµè§ˆå™¨çš„è¡¨å•æäº¤ä¼šè‡ªåŠ¨åŒ…å«CSRF Tokenï¼Œä½†AJAXè¯·æ±‚ä¸ä¼š
         * - å› æ­¤éœ€è¦æ‰‹åŠ¨åœ¨AJAXè¯·æ±‚ä¸­æ·»åŠ CSRF Token
         * 
         * CSRFé˜²æŠ¤å·¥ä½œæµç¨‹ï¼š
         * 1. æœåŠ¡å™¨åœ¨é¡µé¢åŠ è½½æ—¶ç”ŸæˆCSRF Token
         * 2. Tokené€šè¿‡metaæ ‡ç­¾åµŒå…¥åˆ°HTMLä¸­
         * 3. JavaScriptè¯»å–metaæ ‡ç­¾ä¸­çš„Token
         * 4. å‘é€POSTè¯·æ±‚æ—¶ï¼Œåœ¨HTTPå¤´ä¸­åŒ…å«CSRF Token
         * 5. æœåŠ¡å™¨éªŒè¯Tokenï¼ŒåŒ¹é…åˆ™å…è®¸è¯·æ±‚ï¼Œä¸åŒ¹é…åˆ™æ‹’ç»
         */
        
        /**
         * è·å–CSRF Tokenå€¼
         * ä»é¡µé¢çš„metaæ ‡ç­¾ä¸­è¯»å–æœåŠ¡å™¨ç”Ÿæˆçš„CSRF Token
         * @returns {string} CSRF Tokenå­—ç¬¦ä¸²
         */
        function getCsrfToken() {
            return document.querySelector('meta[name="_csrf"]').getAttribute('content');
        }

        /**
         * è·å–CSRF Tokençš„HTTPå¤´åç§°
         * é€šå¸¸æ˜¯ "X-XSRF-TOKEN"ï¼Œä½†å¯èƒ½æ ¹æ®é…ç½®æœ‰æ‰€ä¸åŒ
         * @returns {string} CSRF Tokençš„HTTPå¤´åç§°
         */
        function getCsrfHeader() {
            return document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        }

        document.getElementById('validateBtn').addEventListener('click', function() {
            const resultContainer = document.getElementById('resultContainer');
            const resultDiv = document.getElementById('result');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            resultContainer.style.display = 'block';
            resultDiv.className = 'result loading';
            resultDiv.textContent = 'æ­£åœ¨éªŒè¯ ID Token...';

            /*
             * === CSRF Tokenåœ¨AJAXè¯·æ±‚ä¸­çš„ä½¿ç”¨ ===
             * 
             * é‡è¦ï¼šä¸ºä»€ä¹ˆAJAXè¯·æ±‚éœ€è¦æ‰‹åŠ¨æ·»åŠ CSRF Tokenï¼Ÿ
             * - æµè§ˆå™¨çš„å®‰å…¨ç­–ç•¥ï¼šæ™®é€šçš„HTMLè¡¨å•æäº¤ä¼šè‡ªåŠ¨åŒ…å«CSRF Token
             * - ä½†æ˜¯JavaScriptçš„fetch/XMLHttpRequestä¸ä¼šè‡ªåŠ¨åŒ…å«CSRF Token
             * - æ¶æ„ç½‘ç«™å¯ä»¥å‘é€AJAXè¯·æ±‚ï¼Œä½†æ— æ³•è·å–åˆ°æ­£ç¡®çš„CSRF Token
             * 
             * å®ç°æ­¥éª¤ï¼š
             * 1. åˆ›å»ºHTTPè¯·æ±‚å¤´å¯¹è±¡
             * 2. æ·»åŠ Content-Typeç­‰å¸¸è§„å¤´ä¿¡æ¯
             * 3. ä½¿ç”¨getCsrfHeader()è·å–CSRFå¤´åç§°(é€šå¸¸æ˜¯"X-XSRF-TOKEN")
             * 4. ä½¿ç”¨getCsrfToken()è·å–å®é™…çš„Tokenå€¼
             * 5. å°†Tokenæ·»åŠ åˆ°è¯·æ±‚å¤´ä¸­
             * 
             * å®‰å…¨æ€§è¯´æ˜ï¼š
             * - åªæœ‰æ¥è‡ªåŒæºçš„é¡µé¢æ‰èƒ½è¯»å–metaæ ‡ç­¾ä¸­çš„CSRF Token
             * - æ¶æ„çš„è·¨åŸŸç½‘ç«™æ— æ³•è·å–Tokenï¼Œå› æ­¤æ— æ³•ä¼ªé€ è¯·æ±‚
             */
            
            // ç¬¬1æ­¥ï¼šåˆ›å»ºè¯·æ±‚å¤´å¯¹è±¡ï¼Œæ·»åŠ å¸¸è§„å¤´ä¿¡æ¯
            const headers = {
                'Content-Type': 'application/json',
            };
            
            // ç¬¬2æ­¥ï¼šæ·»åŠ CSRF Tokenåˆ°è¯·æ±‚å¤´
            // æ ¼å¼ï¼šheaders["X-XSRF-TOKEN"] = "actual-token-value"
            headers[getCsrfHeader()] = getCsrfToken();
            
            // ç¬¬3æ­¥ï¼šå‘é€å¸¦æœ‰CSRF Tokençš„POSTè¯·æ±‚
            fetch('/api/validate-token', {
                method: 'POST',
                headers: headers  // åŒ…å«CSRF Tokençš„å®Œæ•´è¯·æ±‚å¤´
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = 'âœ… éªŒè¯æˆåŠŸ!\n\n' + JSON.stringify(data.validation, null, 2);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = 'âŒ éªŒè¯å¤±è´¥: ' + data.message;
                }
            })
            .catch(error => {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ è¯·æ±‚å¤±è´¥: ' + error.message;
                console.error('Error:', error);
            });
        });



        // æäº¤æ‰‹åŠ¨éªŒè¯
        document.getElementById('submitManualValidation').addEventListener('click', function() {
            const tokenInput = document.getElementById('jwtTokenInput');
            const resultContainer = document.getElementById('resultContainer');
            const resultDiv = document.getElementById('result');

            const token = tokenInput.value.trim();
            if (!token) {
                alert('è¯·è¾“å…¥ JWT Token');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            resultContainer.style.display = 'block';
            resultDiv.className = 'result loading';
            resultDiv.textContent = 'æ­£åœ¨éªŒè¯ JWT Token...';

            /*
             * === è¡¨å•æ•°æ®æäº¤ä¸­çš„CSRF Tokenå¤„ç† ===
             * 
             * ä¸åŒçš„Content-Typeéœ€è¦ä¸åŒçš„CSRFå¤„ç†æ–¹å¼ï¼š
             * 
             * 1. application/jsonï¼šTokenæ”¾åœ¨HTTPå¤´ä¸­ (å¦‚ä¸Šé¢çš„ä¾‹å­)
             * 2. application/x-www-form-urlencodedï¼šTokenå¯ä»¥æ”¾åœ¨å¤´ä¸­æˆ–è¡¨å•æ•°æ®ä¸­
             * 3. multipart/form-dataï¼šTokené€šå¸¸æ”¾åœ¨è¡¨å•æ•°æ®ä¸­
             * 
             * è¿™ä¸ªä¾‹å­å±•ç¤ºè¡¨å•ç¼–ç æ–¹å¼ä¸‹çš„CSRF Tokenä½¿ç”¨ï¼š
             * - Content-Typeæ˜¯application/x-www-form-urlencoded
             * - CSRF Tokenä»ç„¶æ”¾åœ¨HTTPå¤´ä¸­ï¼ˆæ¨èæ–¹å¼ï¼‰
             * - è¡¨å•æ•°æ®ä½¿ç”¨URLSearchParamsç¼–ç 
             */
            
            // åˆ›å»ºè¡¨å•è¯·æ±‚çš„è¯·æ±‚å¤´ï¼ŒåŒæ ·éœ€è¦åŒ…å«CSRF Token
            const manualHeaders = {
                'Content-Type': 'application/x-www-form-urlencoded',
            };
            // æ·»åŠ CSRF Tokenåˆ°è¯·æ±‚å¤´ï¼ˆä¸JSONè¯·æ±‚å®Œå…¨ç›¸åŒçš„æ–¹å¼ï¼‰
            manualHeaders[getCsrfHeader()] = getCsrfToken();

            // å‘é€åŒ…å«è¡¨å•æ•°æ®å’ŒCSRF Tokençš„POSTè¯·æ±‚
            fetch('/api/test-validate-token', {
                method: 'POST',
                body: new URLSearchParams({  // è¡¨å•ç¼–ç çš„è¯·æ±‚ä½“
                    'token': token
                }),
                headers: manualHeaders  // åŒ…å«CSRF Tokençš„è¯·æ±‚å¤´
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = 'âœ… æ‰‹åŠ¨éªŒè¯æˆåŠŸ!\n\n' + JSON.stringify(data.validation, null, 2);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = 'âŒ æ‰‹åŠ¨éªŒè¯å¤±è´¥: ' + data.message;
                }
            })
            .catch(error => {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ è¯·æ±‚å¤±è´¥: ' + error.message;
                console.error('Error:', error);
            });
        });
    </script>
</body>
</html>
