# SAGAä¿®å¤è¿›åº¦è·Ÿè¸ªæ–‡æ¡£


## ğŸ“‹ ä»»åŠ¡ç›®æ ‡
ä¿®å¤AO Sagaæ¡†æ¶ï¼Œä½¿å…¶èƒ½å¤Ÿåœ¨AO Tagè¿‡æ»¤æœºåˆ¶ä¸‹æ­£å¸¸å·¥ä½œã€‚

## ğŸ¯ é—®é¢˜èƒŒæ™¯

@README_CN.md æè¿°çš„ä¸¤è¿›ç¨‹ ï¼ˆalice å’Œ bobï¼‰Saga æµ‹è¯•åœ¨ ao å¯¹ Tags è¿›è¡Œè¿‡æ»¤å‰ï¼Œæ˜¯å®é™…æµ‹è¯•é€šè¿‡çš„ï¼
æˆ‘ä»¬ç›®å‰é¢ä¸´çš„é—®é¢˜æ˜¯ï¼šåœ¨ ao ç‰ˆæœ¬æ›´æ–°åï¼Œå¢åŠ äº†å¯¹ Tags çš„è¿‡æ»¤ï¼Œå¯¼è‡´åŸæ¥å·²ç»é€šè¿‡æµ‹è¯•çš„ Saga æ‰§è¡Œè¿‡ç¨‹å¤±è´¥ã€‚
ä¸ºæ­¤æˆ‘ä»¬éœ€è¦æ‰¾åˆ°æ›¿ä»£æ–¹æ¡ˆçš„é—®é¢˜ã€‚ï¼ˆåˆ†æè®¨è®ºå‚è€ƒï¼š @SAGA-TECHNICAL-ANALYSIS.md ï¼‰

> NOTEï¼šä»¥ä¸‹æµ‹è¯•æ˜¯åœ¨æäº¤ `615b9a11a3b1f18deea99e255f9a4ac1da1f0073` å‰ï¼Œæ‰€åšçš„æµ‹è¯•ã€‚è€Œæ­¤åçš„ä»£ç ä¿®æ”¹ï¼Œå³æ˜¯å°è¯•ä½¿ç”¨ Data åµŒå…¥ Saga ä¿¡æ¯æ¥è§£å†³é—®é¢˜ã€‚

ä»å¤±è´¥çš„æµ‹è¯•è®°å½•
@process_alice_1008.txt @process_alice_1008.txt 
æ¥çœ‹ï¼šbob è¿›ç¨‹å·²ç»å¼€å§‹æ‰§è¡Œ Sagaï¼Œç„¶åå‘ alice è¿›ç¨‹å‘å‡ºäº† â€œæŸ¥è¯¢åº“å­˜è¯·æ±‚â€ï¼Œå¹¶ä¸”æ”¶åˆ°äº†å›å¤ï¼š

```
Data = "{"result":{"version":0,"quantity":100,"inventory_item_id":{"location":"y","product_id":1},"entries":[{"...
```

æµ‹è¯•å‘ˆç°å‡ºæ¥çš„é—®é¢˜æ˜¯ï¼š
å› ä¸ºå°è¯•ä½¿ç”¨æ¶ˆæ¯çš„ Tags æ¥ä¼ é€’çš„ Saga ä¿¡æ¯å‘ç”Ÿä¸¢å¤±ï¼ˆè¢« ao æ–°ç‰ˆæœ¬è¿‡æ»¤æ‰äº†ï¼‰ï¼Œå¯¼è‡´ Saga æ— æ³•æ¨è¿›åˆ°ä¸‹ä¸€æ­¥ã€‚
æ¯”å¦‚ï¼Œå¦‚æœå›å¤çš„æ¶ˆæ¯ä¸­æ²¡æœ‰ Action ä¿¡æ¯ï¼Œå°±ä¼šå¯¼è‡´æ— æ³•è§¦å‘ï¼ˆæ¥æ”¶æ¶ˆæ¯çš„è¿›ç¨‹ä¸­çš„ï¼‰ handler çš„å¤„ç†é€»è¾‘ï¼Œè€Œæœªè¢«å¤„ç†çš„æ¶ˆæ¯å°±ä¼šå‡ºç°åœ¨ Inbox ä¸­ã€‚

> NOTEï¼šä»¥ DDDML å·¥å…·ä¸ºâ€œæ–¹æ³•â€ç”Ÿæˆçš„ä»£ç æ¥è¯´ï¼Œå¦‚æœè¦æƒ³è®©æ–¹æ³•çš„å›å¤æ¶ˆæ¯å‡ºç°åœ¨ä¸€ä¸ªè¿›ç¨‹ Inbox é‡Œï¼Œå¯ä»¥åœ¨è¯¥è¿›ç¨‹ï¼ˆå§‘ä¸”ç§°ä¹‹ä¸ºâ€œåŸè¿›ç¨‹â€ï¼‰å†…ç”¨ eval çš„æ–¹å¼æ¥å‘é€â€œè°ƒç”¨æ–¹æ³•â€çš„æ¶ˆæ¯ã€‚
> è¿™æ ·æ”¶åˆ°æ¶ˆæ¯çš„è¿›ç¨‹å°±ä¼šä»æ¶ˆæ¯çš„ From å­—æ®µä¸­çœ‹åˆ°å‘é€æ¶ˆæ¯çš„è¿›ç¨‹ IDï¼Œç„¶åå°†æ‰§è¡Œç»“æœå›å¤ç»™è¿™ä¸ª ID æŒ‡å‘çš„è¿›ç¨‹ã€‚
> å¦‚æœæ”¶åˆ°æ¶ˆæ¯çš„è¿›ç¨‹ï¼ˆåŸè¿›ç¨‹ï¼‰æ²¡æœ‰ handler å¯ä»¥å¤„ç†æ¶ˆæ¯ï¼Œæ¶ˆæ¯å°±ä¼šå‡ºç°åœ¨åŸè¿›ç¨‹çš„ Inbox ä¸­ã€‚
> å¯ä»¥æŸ¥çœ‹ç¤ºä¾‹ @ao-cli-non-repl/tests/run-blog-tests.sh

æˆ‘ä»¬åœ¨ @SAGA-TECHNICAL-ANALYSIS.md ä¸­åˆ†æäº†è¿™ä¸ªé—®é¢˜ã€‚
æ‰€ä»¥æ‰å¯¼è‡´äº†æœ¬æ¬¡ä»»åŠ¡çš„ä¸€ç³»åˆ—çš„ä»£ç ä¿®æ”¹â€”â€”å°è¯•ä½¿ç”¨åœ¨æ¶ˆæ¯çš„ Data ä¸­åµŒå…¥ Saga æ¶ˆæ¯ä»¥ä»£æ›¿åœ¨ Tags ä¸­åŒ…å« Saga ä¿¡æ¯çš„â€œæ—§åšæ³•â€ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼š
- **åŸå§‹çŠ¶æ€**: README_CN.mdæè¿°çš„alice-bobä¸¤è¿›ç¨‹SAGAæµ‹è¯•æ›¾ç»é€šè¿‡
- **å½“å‰é—®é¢˜**: AOç‰ˆæœ¬æ›´æ–°åï¼ŒTagè¿‡æ»¤æœºåˆ¶å¯¼è‡´SAGAæ— æ³•æ¨è¿›
- **æ ¸å¿ƒåŸå› **: è‡ªå®šä¹‰Tagï¼ˆå¦‚X-SagaIdï¼‰åœ¨è·¨è¿›ç¨‹ä¼ é€’æ—¶è¢«AOç³»ç»Ÿè¿‡æ»¤
- **è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨DataåµŒå…¥æ›¿ä»£Tagä¼ é€’Sagaä¿¡æ¯

å®ç°è¿‡ç¨‹ä¸­æˆ‘ä»¬éœ€è¦æ³¨æ„ä¸¤ä¸ªå…³é”®ç‚¹ï¼š
- Saga IDï¼ˆ`X-SagaID`ï¼‰æ˜¯å¦åœ¨ Saga çš„æ‰§è¡Œè¿‡ç¨‹ä¸­æ˜¯å¦è¢«æ­£ç¡®â€œç»´æŠ¤â€ï¼ˆæ²¡æœ‰ä¸­é€”ä¸¢å¤±ï¼‰ï¼Ÿ
- æ¥æ”¶æ¶ˆæ¯çš„è¿›ç¨‹æ˜¯å¦å¯ä»¥è·å–åˆ°â€œå›å¤æ¶ˆæ¯çš„ Actionâ€ï¼ˆ`X-ResponseAction`ï¼‰ï¼Œä»¥åŠåœ¨å‘é€å›å¤æ¶ˆæ¯æ—¶æ˜¯å¦æ­£ç¡®è®¾ç½®äº† Actionï¼Ÿ

## ğŸ” å…³é”®å‘ç°è®°å½•

### å‘ç° #1: Action Tagå¯ä»¥æ­£å¸¸ä¼ é€’ âœ…
**æ—¶é—´**: 2025-01-10
**æµ‹è¯•**: test_process_a.lua + test_process_b.lua
**ç»“è®º**: 
- Actionå¯ä»¥ä½œä¸ºTagæ­£å¸¸ä¼ é€’ï¼ˆ`Tags = { Action = "..." }`ï¼‰
- Actionä¹Ÿå¯ä»¥ä½œä¸ºç›´æ¥å±æ€§ä¼ é€’ï¼ˆ`message.Action = "..."`ï¼‰
- AOä¼šè‡ªåŠ¨åœ¨ä¸¤ç§å½¢å¼é—´è½¬æ¢
- å½“åŒæ—¶è®¾ç½®æ—¶ï¼Œå€¼ä¼šäº¤å‰ï¼ˆå‘é€Action=A,Tags.Action=Bï¼Œæ¥æ”¶Action=B,Tags.Action=Aï¼‰

**æµ‹è¯•è¯æ®**:
```json
{
  "test": "Test1_ActionInTags",
  "action_in_tags": "TestActionInTags",
  "action_direct": "TestActionInTags"
}
```

**é‡è¦æ€§**: â­â­â­â­â­
**å½±å“**: è¿™æ„å‘³ç€ä¹‹å‰è®¤ä¸º"Actionè¢«è¿‡æ»¤"çš„ç»“è®ºæ˜¯é”™è¯¯çš„ï¼HandleråŒ¹é…åº”è¯¥å¯ä»¥æ­£å¸¸å·¥ä½œï¼

### å‘ç° #2: SAGAå·²ç»æ¨è¿›åˆ°æ­¥éª¤2 âœ…
**æ—¶é—´**: 2025-01-10
**æµ‹è¯•**: æ‰‹åŠ¨è°ƒè¯•alice-bobæµ‹è¯•
**ç»“è®º**:
- SAGA Instanceå½“å‰åœ¨æ­¥éª¤2ï¼ˆ`current_step: 2`ï¼‰
- æ­¥éª¤1çš„callbackï¼ˆGetInventoryItemï¼‰å·²ç»æˆåŠŸè§¦å‘
- é—®é¢˜å‡ºåœ¨æ­¥éª¤2çš„callbackï¼ˆCreateSingleLineInOutï¼‰æœªè¢«è§¦å‘

**æµ‹è¯•è¯æ®**:
```bash
ao-cli eval "$BOB" --data "saga = require('saga'); local inst = saga.get_saga_instance_copy(1); return inst and inst.current_step or 0"
# è¾“å‡º: "2"
```

**é‡è¦æ€§**: â­â­â­â­â­
**å½±å“**: SAGAæ ¸å¿ƒé€»è¾‘æ˜¯å·¥ä½œçš„ï¼é—®é¢˜å¯èƒ½ä¸åœ¨Actionä¼ é€’ï¼Œè€Œåœ¨å…¶ä»–åœ°æ–¹ï¼

### å‘ç° #3: Callback HandleræŠ¥é”™ INVALID_MESSAGE âœ…
**æ—¶é—´**: 2025-01-10
**æµ‹è¯•**: æ·»åŠ é”™è¯¯è¿½è¸ªåˆ°callback handler
**ç»“è®º**:
- æ‰‹åŠ¨å‘é€GetInventoryItem callbackæ—¶æŠ¥é”™ `INVALID_MESSAGE`
- é”™è¯¯å‘ç”Ÿåœ¨ `inventory_service.lua:100` çš„æ£€æŸ¥ï¼š
  ```lua
  if (saga_instance.current_step ~= 1 or saga_instance.compensating) then
      error(ERRORS.INVALID_MESSAGE)
  end
  ```
- å› ä¸ºSAGAå·²ç»åœ¨æ­¥éª¤2ï¼Œæ‰€ä»¥æ£€æŸ¥å¤±è´¥

**æµ‹è¯•è¯æ®**:
```json
{
  "error": "[string \"aos\"]:1843: INVALID_MESSAGE",
  "time": 1760086448414
}
```

**é‡è¦æ€§**: â­â­â­â­
**å½±å“**: è¿™è¯æ˜äº†SAGAåœ¨ç¬¬ä¸€æ¬¡çœŸå®çš„callbackæ—¶å·²ç»æ¨è¿›åˆ°æ­¥éª¤2ï¼è¯´æ˜æ­¥éª¤1æˆåŠŸäº†ï¼

### å‘ç° #4: Aliceæœ‰CreateSingleLineInOut handler âœ…
**æ—¶é—´**: 2025-01-10
**æµ‹è¯•**: æ£€æŸ¥aliceè¿›ç¨‹çš„handlers
**ç»“è®º**: aliceç¡®å®æœ‰`create_single_line_in_out` handler

**é‡è¦æ€§**: â­â­â­
**å½±å“**: Handlerå­˜åœ¨ï¼Œé—®é¢˜å¯èƒ½åœ¨æ¶ˆæ¯ä¼ é€’æˆ–handlerè§¦å‘æ¡ä»¶

## ğŸš§ å½“å‰é—®é¢˜åˆ†æ

### é—®é¢˜ç„¦ç‚¹: ä¸ºä»€ä¹ˆæ­¥éª¤2å¡ä½äº†ï¼Ÿ

**å·²çŸ¥ä¿¡æ¯**:
1. âœ… Actionå¯ä»¥æ­£å¸¸ä¼ é€’
2. âœ… æ­¥éª¤1æˆåŠŸå®Œæˆï¼ˆSAGAæ¨è¿›åˆ°æ­¥éª¤2ï¼‰
3. âœ… aliceæœ‰CreateSingleLineInOut handler
4. â“ æ­¥éª¤2çš„callbackæœªè¢«è§¦å‘

**å¯èƒ½åŸå› **:
1. **æ¶ˆæ¯æœªå‘é€**: bobæœªå‘aliceå‘é€CreateSingleLineInOutè¯·æ±‚
2. **æ¶ˆæ¯æœªåˆ°è¾¾**: æ¶ˆæ¯å‘é€äº†ä½†aliceæœªæ”¶åˆ°
3. **HandleræœªåŒ¹é…**: æ¶ˆæ¯åˆ°è¾¾ä½†handleråŒ¹é…å¤±è´¥
4. **Handleræ‰§è¡Œå¤±è´¥**: handleråŒ¹é…ä½†æ‰§è¡Œæ—¶å‡ºé”™

### å‘ç° #5: GetInventoryItem Callbackä»æœªè¢«è°ƒç”¨ï¼ğŸ”¥
**æ—¶é—´**: 2025-01-10
**æµ‹è¯•**: æ·»åŠ DEBUG_LOGè¿½è¸ªcallbackè°ƒç”¨
**ç»“è®º**:
- æ–°åˆ›å»ºçš„SAGAå®ä¾‹2ï¼Œcurrent_step=1
- GetInventoryItem callbackæœªè¢«è°ƒç”¨ï¼ˆDEBUG_LOGä¸ºç©ºï¼‰
- ç”¨æˆ·ç¡®è®¤ï¼šåœ¨ä¿®æ”¹ä»£ç å‰ï¼Œè¿™äº›æ­¥éª¤éƒ½æ˜¯å·¥ä½œçš„ï¼

**é‡è¦æ€§**: â­â­â­â­â­
**å½±å“**: ä»£ç é€»è¾‘æ£€æŸ¥ï¼š
1. âœ… bobçš„SAGAå¯åŠ¨ä»£ç æ­£ç¡®åœ°åµŒå…¥Sagaä¿¡æ¯åˆ°request Dataä¸­
2. âœ… `messaging.commit_send_or_error` -> `send` æ­£ç¡®å‘é€Dataå’ŒTags
3. âœ… aliceçš„handleræ­£ç¡®æå–Sagaä¿¡æ¯å¹¶å¤„ç†
4. âœ… `messaging.respond`æ­£ç¡®åµŒå…¥Sagaä¿¡æ¯åˆ°response Dataå¹¶è®¾ç½®Action tag
5. â“ bobçš„callback handlerå®šä¹‰æ˜¯å¦æ­£ç¡®ï¼Ÿ

### å‘ç° #6: å…³é”®ç–‘ç‚¹ - callback handlerçš„åŒ¹é…é€»è¾‘ ğŸ”¥
**æ—¶é—´**: 2025-01-10
**æ€€ç–‘**: æˆ‘ä»¬ä¿®æ”¹äº†callback handlersä½¿ç”¨`messaging.hasMatchingDataAction`ï¼Œä½†æµ‹è¯•è¯æ˜Actionå¯ä»¥æ­£å¸¸ä¼ é€’ï¼
**éœ€è¦éªŒè¯**: bobçš„callback handleræ˜¯å¦é”™è¯¯åœ°ä½¿ç”¨äº†DataåŒ¹é…è€Œä¸æ˜¯TagåŒ¹é…ï¼Ÿ

### å‘ç° #7: çœŸæ­£çš„é—®é¢˜ - X-ResponseActionè¢«è¿‡æ»¤ï¼ğŸ’¡ğŸ’¡ğŸ’¡
**æ—¶é—´**: 2025-01-10
**ç”¨æˆ·æ¾„æ¸…**: 
- âœ… Action tag **ä¸ä¼š**è¢«è¿‡æ»¤
- âŒ **è‡ªå®šä¹‰çš„X-ResponseAction tagè¢«è¿‡æ»¤**
- é—®é¢˜ï¼šåŸå§‹SAGAå®ç°ä¾èµ–`X-ResponseAction` tagæ¥ä¼ é€’callbackçš„Actionåç§°

**åŸå§‹SAGAå·¥ä½œæµç¨‹**ï¼ˆä¿®æ”¹å‰ï¼‰:
1. bobå‘é€GetInventoryItemè¯·æ±‚ï¼ŒTagsåŒ…å«ï¼š`X-SagaId`, `X-ResponseAction=GetInventoryItem_Callback`
2. aliceæ”¶åˆ°è¯·æ±‚ï¼Œä»Tagsæå–`X-ResponseAction`
3. aliceå“åº”æ—¶ï¼Œå°†`X-ResponseAction`çš„å€¼ä½œä¸ºresponseçš„`Action` tagå‘é€å›å»
4. bobæ”¶åˆ°å“åº”ï¼Œæ ¹æ®`Action` tagåŒ¹é…callback handler

**ä¸ºä»€ä¹ˆå¤±è´¥**:
- AOè¿‡æ»¤äº†è‡ªå®šä¹‰tag `X-ResponseAction`
- aliceæ”¶ä¸åˆ°`X-ResponseAction`ï¼Œæ— æ³•çŸ¥é“åº”è¯¥è®¾ç½®ä»€ä¹ˆ`Action`ç»™å“åº”æ¶ˆæ¯
- bobæ”¶åˆ°çš„å“åº”æ¶ˆæ¯æ²¡æœ‰æ­£ç¡®çš„`Action` tag
- callback handleræ— æ³•è¢«è§¦å‘

**è§£å†³æ–¹æ¡ˆ**:
æˆ‘ä»¬çš„DataåµŒå…¥æ–¹æ¡ˆæ˜¯å¯¹çš„ï¼ä½†éœ€è¦ç¡®ä¿ï¼š
1. âœ… bobåœ¨request Dataä¸­åµŒå…¥`X-ResponseAction`ï¼ˆå·²å®ç°ï¼‰
2. âœ… aliceä»Dataä¸­æå–`X-ResponseAction`ï¼ˆå·²å®ç°ï¼‰
3. âœ… aliceåœ¨responseæ—¶å°†`X-ResponseAction`ä½œä¸º`Action` tagï¼ˆå·²å®ç°ï¼‰
4. âœ… bobçš„callback handlerä½¿ç”¨TagåŒ¹é…è€Œä¸æ˜¯DataåŒ¹é…ï¼ˆå·²ä¿®å¤ï¼‰

### å‘ç° #8: Bugä¿®å¤ï¼ğŸ‰
**æ—¶é—´**: 2025-01-10
**Bug**: æ‰€æœ‰SAGA callback handlersé”™è¯¯åœ°ä½¿ç”¨äº†`messaging.hasMatchingDataAction`
**ä¿®å¤**: æ”¹ä¸ºä½¿ç”¨`Handlers.utils.hasMatchingTag("Action", ...)`
**åŸå› **: 
- `Action` tagä¸ä¼šè¢«è¿‡æ»¤
- `messaging.respond`å·²ç»æ­£ç¡®åœ°å°†`X-ResponseAction`ä»Dataä¸­æå–å¹¶è®¾ç½®ä¸º`Action` tag
- callback handleråº”è¯¥åŒ¹é…`Action` tagè€Œä¸æ˜¯ä»Dataä¸­æå–

**ä¿®å¤çš„æ–‡ä»¶**:
- `src/a_ao_demo.lua`: å°†5ä¸ªcallback handlersæ”¹ä¸ºä½¿ç”¨TagåŒ¹é…
- `src/messaging.lua`: åˆ é™¤äº†ä¸å†éœ€è¦çš„`messaging.hasMatchingDataAction`å‡½æ•°

## ğŸ”¬ ä¸‹ä¸€æ­¥è°ƒè¯•è®¡åˆ’

### Plan A: æ£€æŸ¥bobæ˜¯å¦å‘é€äº†GetInventoryItemè¯·æ±‚ âœ… è¿›è¡Œä¸­
- [x] æ·»åŠ DEBUG_LOG
- [ ] åœ¨SAGAèµ·å§‹handlerä¸­æ·»åŠ æ—¥å¿—ï¼Œç¡®è®¤æ˜¯å¦å‘é€äº†è¯·æ±‚

### Plan B: æ£€æŸ¥aliceæ˜¯å¦æ”¶åˆ°GetInventoryItemè¯·æ±‚
- [ ] åœ¨aliceçš„`get_inventory_item` handlerä¸­æ·»åŠ æ—¥å¿—
- [ ] æ£€æŸ¥aliceæ˜¯å¦æ”¶åˆ°æ¶ˆæ¯

### Plan C: æ£€æŸ¥aliceçš„å“åº”æ¶ˆæ¯
- [ ] æ£€æŸ¥aliceçš„å“åº”æ˜¯å¦åŒ…å«æ­£ç¡®çš„Action
- [ ] æ£€æŸ¥å“åº”çš„Dataæ˜¯å¦åŒ…å«Sagaä¿¡æ¯

## ğŸ“ ä»£ç ä¿®æ”¹è®°å½•

### ä¿®æ”¹ #1: messaging.hasMatchingDataAction (å¯èƒ½ä¸éœ€è¦)
**æ–‡ä»¶**: src/a_ao_demo.lua, src/messaging.lua
**åŸå› **: è¯¯è®¤ä¸ºAction tagè¢«è¿‡æ»¤
**çŠ¶æ€**: âš ï¸ å¯èƒ½éœ€è¦å›é€€

### ä¿®æ”¹ #2: DataåµŒå…¥Sagaä¿¡æ¯
**æ–‡ä»¶**: src/messaging.lua, src/inventory_service.lua
**åŸå› **: æ›¿ä»£Tagä¼ é€’
**çŠ¶æ€**: âœ… ä¿ç•™ï¼ˆä½œä¸ºå¢å¼ºåŠŸèƒ½ï¼‰

## ğŸ¯ æµ‹è¯•ç›®æ ‡
- [ ] `run-saga-tests.sh` å®Œå…¨é€šè¿‡
- [ ] aliceçš„åº“å­˜æ•°é‡æ›´æ–°ä¸º119
- [ ] bobçš„SAGAå®ä¾‹çŠ¶æ€ä¸ºcompleted

## ğŸ”¥ æœ€æ–°æµ‹è¯•ç»“æœ
**æ—¶é—´**: 2025-01-10
**çŠ¶æ€**: âŒ å¤±è´¥
**SAGAçŠ¶æ€**: å¡åœ¨æ­¥éª¤2ï¼ˆcurrent_step=2, completed=falseï¼‰
**åº“å­˜çŠ¶æ€**: æœªæ›´æ–°ï¼ˆä»ä¸º100ï¼‰

**é—®é¢˜åˆ†æ**:
- âŒ **æ­¥éª¤1çš„callbackä»æœªè¢«è§¦å‘ï¼** ï¼ˆBOB_CALLBACK_LOGä¸ºç©ºï¼‰
- âŒ bobçš„Inboxæ²¡æœ‰aliceçš„å“åº”æ¶ˆæ¯
- â“ aliceæ˜¯å¦å‘é€äº†å“åº”ï¼Ÿæˆ–è€…å“åº”çš„Action tagä¸æ­£ç¡®ï¼Ÿ

### å‘ç° #9: æ ¸å¿ƒé—®é¢˜ - æ­¥éª¤1çš„callbackæœªè¢«è§¦å‘ ğŸ”¥ğŸ”¥ğŸ”¥
**æ—¶é—´**: 2025-01-10  
**å…³é”®å‘ç°**:
- SAGAæ¨è¿›åˆ°æ­¥éª¤2ï¼Œä½†è¿™å¯èƒ½æ˜¯saga.create_saga_instanceæ—¶é»˜è®¤è®¾ç½®çš„
- æ­¥éª¤1çš„GetInventoryItem_Callbackä»æœªæ‰§è¡Œï¼ˆcallbackæ—¥å¿—ä¸ºç©ºï¼‰
- bobçš„Inboxæ²¡æœ‰æ¥è‡ªaliceçš„å“åº”æ¶ˆæ¯
- **å¯èƒ½åŸå› **:
  1. aliceçš„handleræ²¡æœ‰è¢«è§¦å‘ï¼ˆæ²¡æ”¶åˆ°è¯·æ±‚ï¼‰
  2. aliceçš„handleræ‰§è¡Œå‡ºé”™ï¼ˆæ²¡å‘é€å“åº”ï¼‰
  3. aliceå‘é€äº†å“åº”ï¼Œä½†Action tagè®¾ç½®ä¸æ­£ç¡®ï¼Œå¯¼è‡´æ²¡æœ‰handleråŒ¹é…ï¼ˆæ¶ˆæ¯åº”è¯¥åœ¨bobçš„Inboxï¼‰

### å‘ç° #10: è·¨è¿›ç¨‹æ¶ˆæ¯æœªåˆ°è¾¾ ğŸ”¥ğŸ”¥ğŸ”¥
**æ—¶é—´**: 2025-01-10
**æµ‹è¯•ç»“æœ**:
- ä»bobç”¨`Send()`å‘aliceå‘é€GetInventoryItemè¯·æ±‚
- ç­‰å¾…15ç§’åï¼Œbobæ²¡æœ‰æ”¶åˆ°ä»»ä½•å“åº”
- bobçš„Inboxä»ç„¶åªæœ‰åˆå§‹æ¶ˆæ¯
- bobçš„callbackæ—¥å¿—ä¸ºç©º

**æ€€ç–‘**:
1. â“ `ao.send()`åœ¨evalä¸­æ˜¯å¦èƒ½æ­£å¸¸å‘é€è·¨è¿›ç¨‹æ¶ˆæ¯ï¼Ÿ
2. â“ aliceæ˜¯å¦çœŸçš„æ”¶åˆ°äº†bobçš„è¯·æ±‚ï¼Ÿ
3. â“ aliceæ˜¯å¦è°ƒç”¨äº†`messaging.respond`ï¼Ÿ
4. â“ `ao-cli eval`çš„è¾“å‡ºè§£ææ˜¯å¦æœ‰é—®é¢˜ï¼ˆå¾ˆå¤ševalè¿”å›ç©ºï¼‰ï¼Ÿ

**ä¸‹ä¸€æ­¥**:
- éœ€è¦éªŒè¯è·¨è¿›ç¨‹æ¶ˆæ¯ä¼ é€’æ˜¯å¦çœŸçš„å·¥ä½œ
- å¯èƒ½éœ€è¦ç”¨`ao-cli message`è€Œä¸æ˜¯`eval`ä¸­çš„`Send()`æ¥è§¦å‘SAGA

### å‘ç° #11: çœŸæ­£çš„BUG - saga.create_saga_instanceä¸ä¿å­˜dataï¼ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥
**æ—¶é—´**: 2025-01-10
**æ ¹æœ¬åŸå› æ‰¾åˆ°äº†ï¼**

**Bugåˆ†æ**:
```lua
-- src/saga.lua:58-63
saga_instance.participants[#saga_instance.participants + 1] = {
    {
        target = target,
        tags = tags,
        -- âŒ ç¼ºå°‘: data = data
    },
}
```

**é—®é¢˜é“¾æ¡**:
1. `inventory_service.lua:88`åˆ›å»ºåŒ…å«Sagaä¿¡æ¯çš„`request`ï¼ˆdataï¼‰
2. è°ƒç”¨`messaging.commit_send_or_error(status, request_or_error, commit, target, tags)`
3. `request_or_error`ï¼ˆåŒ…å«Sagaä¿¡æ¯çš„dataï¼‰è¢«ä¼ é€’ç»™`send`å‡½æ•°
4. `send`å‡½æ•°æ­£ç¡®åœ°å‘é€äº†data
5. **ä½†æ˜¯**`saga.create_saga_instance`åˆ›å»ºparticipantæ—¶ï¼Œæ ¹æœ¬æ²¡æœ‰æ¥æ”¶å’Œå­˜å‚¨dataå‚æ•°ï¼
6. æ‰€ä»¥participantä¸­çš„dataæ˜¯`nil`
7. è™½ç„¶ç¬¬ä¸€æ¬¡æ¶ˆæ¯å‘é€æ—¶dataæ˜¯æ­£ç¡®çš„ï¼ˆå› ä¸ºç›´æ¥ä¼ ç»™äº†sendï¼‰
8. ä½†è¿™ä¸ªè®¾è®¡æœ¬èº«å°±æœ‰é—®é¢˜ - participantåº”è¯¥è®°å½•å®Œæ•´çš„æ¶ˆæ¯ä¿¡æ¯

**ç­‰ç­‰ï¼** å¦‚æœç¬¬ä¸€æ¬¡å‘é€çš„dataæ˜¯æ­£ç¡®çš„ï¼Œé‚£aliceåº”è¯¥èƒ½æ”¶åˆ°Sagaä¿¡æ¯å¹¶æ­£ç¡®å“åº”å•Šï¼Ÿ

**é‡æ–°åˆ†æ**ï¼šæˆ–è®¸é—®é¢˜ä¸åœ¨è¿™é‡Œï¼Ÿè®©æˆ‘æ£€æŸ¥bobå®é™…å‘é€çš„æ¶ˆæ¯å†…å®¹...

### å‘ç° #12: ao-cli evalä¸­çš„Send()è·¨è¿›ç¨‹æ¶ˆæ¯æœªåˆ°è¾¾ ğŸš¨ğŸš¨ğŸš¨
**æ—¶é—´**: 2025-01-10
**æµ‹è¯•ç»“æœ**:
1. ä»aliceç”¨`Send()`å‘bobå‘é€æ¶ˆæ¯ â†’ bobæ²¡æœ‰æ”¶åˆ°ï¼ˆBOB_MSG_LOGä¸ºç©ºï¼‰
2. ç”¨`ao-cli message`ä»å¤–éƒ¨å‘bobå‘é€æ¶ˆæ¯ â†’ æµ‹è¯•ä¸­ï¼ˆä½†ao-cli evalè¾“å‡ºè§£ææœ‰é—®é¢˜ï¼‰
3. aliceçš„get_inventory_item handlerä»æœªè¢«è§¦å‘ï¼ˆGET_INV_ITEM_LOGä¸ºç©ºï¼‰
4. è¿™æ„å‘³ç€bobä»æœªå‘aliceå‘é€GetInventoryItemè¯·æ±‚

**æ ¸å¿ƒé—®é¢˜**:
- **`eval`ä¸­çš„`Send()`å¯èƒ½æ— æ³•å‘é€è·¨è¿›ç¨‹æ¶ˆæ¯åˆ°å¦ä¸€ä¸ªé•¿æœŸè¿è¡Œçš„è¿›ç¨‹**
- æˆ–è€…æ¶ˆæ¯å‘é€äº†ä½†éœ€è¦æ›´é•¿æ—¶é—´æ‰èƒ½åˆ°è¾¾
- æˆ–è€…`ao-cli eval`çš„è¾“å‡ºè§£ææœ‰ä¸¥é‡é—®é¢˜ï¼Œå¯¼è‡´æ— æ³•æ­£ç¡®æŸ¥çœ‹æ—¥å¿—

**ao-cli evalè¾“å‡ºé—®é¢˜**:
- å¾ˆå¤ševalå‘½ä»¤è¿”å›ç©ºOutput
- å³ä½¿æ˜¯ç®€å•çš„`return tostring(#BOB_MSG_LOG)`ä¹Ÿè¿”å›ç©º
- è¿™ä½¿å¾—è°ƒè¯•å˜å¾—éå¸¸å›°éš¾

**ä¸‹ä¸€æ­¥**:
éœ€è¦ç”¨æˆ·ç¡®è®¤æˆ–å°è¯•å…¶ä»–è°ƒè¯•æ–¹æ³•ï¼ˆå¦‚aos CLIï¼Œè™½ç„¶ç”¨æˆ·ä¸æ¨èï¼‰

## ğŸš¨ æ ¸å¿ƒå‘ç°ï¼šSAGAå¡åœ¨æ­¥éª¤2çš„çœŸç›¸

**æ—¶é—´**: 2025-01-10
**çŠ¶æ€**: ğŸ”´ ä¸¥é‡é—®é¢˜

### å…³é”®è¯æ®é“¾ï¼š

1. **SAGAçŠ¶æ€**: current_step=2, completed=false
2. **Step 1 callback**: å·²æ‰§è¡Œ4æ¬¡ (DEBUG_GET_INVENTORY_ITEM_CALLBACK_COUNT=4)
3. **Step 2è¯·æ±‚**: aliceæ”¶åˆ°0æ¬¡ (DEBUG_CREATE_SINGLE_LINE_IN_OUT_COUNT=0)
4. **Bob Inbox**: æœ‰aliceçš„CreateSingleLineInOutå“åº”ï¼Œä½†**æ²¡æœ‰Action tag**ï¼

### é—®é¢˜å®šä½ï¼š

#### å‘ç° #13: Aliceçš„å“åº”æ¶ˆæ¯ç¼ºå°‘Action tag ğŸ”¥ğŸ”¥ğŸ”¥
**è¯æ®**: Bob Inboxæœ€åä¸€æ¡æ¶ˆæ¯ï¼š
```json
{
  "From": "aliceè¿›ç¨‹ID",
  "Data": "{\"result\":{\"version\":0,\"in_out_id\":1}}",
  "Tags": {
    // âŒ æ²¡æœ‰Action tagï¼
  }
}
```

#### å‘ç° #14: messaging.respondæå–çš„response_actionæ˜¯æ­£ç¡®çš„ âœ…
**è¯æ®**: `DEBUG_MESSAGING_RESPOND_CALLS`æ˜¾ç¤ºï¼š
```
response_action = "InventoryService_ProcessInventorySurplusOrShortage_CreateSingleLineInOut_Callback"
```

#### å‘ç° #15: å“åº”Dataä¸­ä¹Ÿæ²¡æœ‰Sagaä¿¡æ¯ âŒ
**è¯æ®**: Bob Inboxæ¶ˆæ¯çš„Dataä¸­æ²¡æœ‰`X-SagaId`

### æ ¹æœ¬åŸå› æ¨æµ‹ï¼š

**`messaging.respond`çš„é€»è¾‘æœ‰bugï¼**

è™½ç„¶`messaging.extract_saga_info_from_data`æå–åˆ°äº†æ­£ç¡®çš„`response_action`ï¼Œä½†ï¼š
1. `message.Tags`æ²¡æœ‰è¢«æ­£ç¡®è®¾ç½®ï¼ˆæˆ–è¢«AOè¿‡æ»¤ï¼‰
2. å“åº”Dataä¸­æ²¡æœ‰åµŒå…¥Sagaä¿¡æ¯

**éœ€è¦æ£€æŸ¥çš„ä»£ç è·¯å¾„**:
```lua
-- messaging.respondä¸­
if response_action then
    message.Tags = { Action = response_action }  -- â“ è¿™é‡Œè®¾ç½®äº†ï¼Œä¸ºä»€ä¹ˆbobæ”¶ä¸åˆ°ï¼Ÿ
end

if saga_id then
    data = messaging.embed_saga_info_in_data(data, saga_id, response_action)
    message.Data = json.encode(data)  -- â“ è¿™é‡Œé‡æ–°ç¼–ç äº†ï¼Œä½†ä¸ºä»€ä¹ˆbobæ”¶åˆ°çš„Dataä¸­æ²¡æœ‰Sagaä¿¡æ¯ï¼Ÿ
end
```

### ä¸‹ä¸€æ­¥è°ƒè¯•è®¡åˆ’ï¼š

1. âœ… éªŒè¯ï¼š`messaging.respond`æ˜¯å¦è¢«è°ƒç”¨
2. âœ… éªŒè¯ï¼š`response_action`æ˜¯å¦æ­£ç¡®æå–
3. â³ **éªŒè¯**ï¼š`messaging.respond`ä¸­`ao.send(message)`å‘é€çš„æ¶ˆæ¯æ˜¯å¦åŒ…å«æ­£ç¡®çš„Tagså’ŒData
4. â³ **éªŒè¯**ï¼šBobæ”¶åˆ°çš„æ¶ˆæ¯ä¸aliceå‘é€çš„æ¶ˆæ¯æ˜¯å¦ä¸€è‡´

## ğŸ’¡ é‡è¦æ´å¯Ÿ

### æ´å¯Ÿ #1: ä¸è¦è¿‡æ—©ä¸‹ç»“è®º
ä¹‹å‰è®¤ä¸ºActionè¢«è¿‡æ»¤æ˜¯é”™è¯¯çš„ã€‚éœ€è¦é€šè¿‡å®é™…æµ‹è¯•éªŒè¯æ¯ä¸€ä¸ªå‡è®¾ã€‚

### æ´å¯Ÿ #2: SAGAé€»è¾‘æ˜¯å·¥ä½œçš„
æ­¥éª¤1æˆåŠŸå®Œæˆè¯æ˜äº†SAGAæ ¸å¿ƒé€»è¾‘ã€æ¶ˆæ¯ä¼ é€’æœºåˆ¶ã€ActionåŒ¹é…éƒ½æ˜¯å¯ä»¥å·¥ä½œçš„ã€‚

### æ´å¯Ÿ #3: é—®é¢˜å¯èƒ½å¾ˆç®€å•
å¯èƒ½ä¸éœ€è¦`messaging.hasMatchingDataAction`è¿™æ ·çš„å¤æ‚ä¿®æ”¹ã€‚é—®é¢˜å¯èƒ½åªæ˜¯æŸä¸ªå°bugã€‚

### æ´å¯Ÿ #4: messaging.respondçš„Dataå¤„ç†æœ‰bug
`messaging.respond`ä¸­å…ˆå°†dataç¼–ç ä¸ºJSONï¼Œç„¶ååˆå°è¯•ä¿®æ”¹dataå¹¶é‡æ–°ç¼–ç ï¼Œè¿™ä¸ªæµç¨‹æœ‰é—®é¢˜ï¼

## ğŸ‰ æœ€ç»ˆè§£å†³æ–¹æ¡ˆä¸æ ¸å¿ƒç»éªŒæ•™è®­

**æ—¶é—´**: 2025-01-10
**çŠ¶æ€**: âœ… å®Œå…¨è§£å†³

### ğŸ”¥ æ ¸å¿ƒBugå®šä½

**é—®é¢˜æ ¹æº**ï¼š`messaging.respond`å‡½æ•°ä¸­çš„é€»è¾‘é”™è¯¯

```lua
-- âŒ é”™è¯¯çš„å®ç°
if saga_id then
    data = messaging.embed_saga_info_in_data(data, saga_id, response_action)  -- é”™è¯¯ï¼
    message.Data = json.encode(data)
end
```

**é—®é¢˜åˆ†æ**ï¼š
1. `response_action`æ˜¯ä»**è¯·æ±‚æ¶ˆæ¯**ä¸­æå–çš„ï¼Œè¡¨ç¤º"æ”¶åˆ°å“åº”æ—¶åº”è¯¥è§¦å‘çš„callback action"
2. è¿™ä¸ªå€¼å·²ç»æ­£ç¡®è®¾ç½®åœ¨å“åº”æ¶ˆæ¯çš„`Tags.Action`ä¸­ç”¨äºè§¦å‘callback handler
3. **ä¸åº”è¯¥**å†æ¬¡å°†å®ƒåµŒå…¥åˆ°å“åº”Dataä¸­
4. å“åº”Dataä¸­åªéœ€è¦åµŒå…¥`saga_id`ï¼Œcallback handleråªéœ€è¦è¯†åˆ«SAGAå®ä¾‹

### âœ… æ­£ç¡®çš„å®ç°

```lua
-- âœ… æ­£ç¡®çš„å®ç°
if saga_id then
    data = messaging.embed_saga_info_in_data(data, saga_id, nil)  -- åªåµŒå…¥saga_id
    message.Data = json.encode(data)
end
```

### ğŸ“š æ ¸å¿ƒç»éªŒæ•™è®­

#### æ•™è®­ #1: åŒºåˆ†è¯·æ±‚å’Œå“åº”çš„Sagaä¿¡æ¯
- **è¯·æ±‚æ¶ˆæ¯**éœ€è¦åµŒå…¥ï¼š`saga_id` + `response_action`ï¼ˆå‘Šè¯‰å¯¹æ–¹æ”¶åˆ°å“åº”åè°ƒç”¨å“ªä¸ªcallbackï¼‰
- **å“åº”æ¶ˆæ¯**åªéœ€åµŒå…¥ï¼š`saga_id`ï¼ˆè®©callbackè¯†åˆ«SAGAå®ä¾‹ï¼‰
- **å“åº”æ¶ˆæ¯**çš„`Tags.Action`åº”è¯¥è®¾ç½®ä¸º**è¯·æ±‚æ¶ˆæ¯**ä¸­çš„`response_action`

#### æ•™è®­ #2: DataåµŒå…¥æ˜¯ç»•è¿‡AO Tagè¿‡æ»¤çš„å”¯ä¸€å¯é æ–¹æ¡ˆ
- âœ… **Action tagä¸ä¼šè¢«è¿‡æ»¤**ï¼šå¯ä»¥ç”¨äºhandleråŒ¹é…
- âŒ **è‡ªå®šä¹‰tagä¼šè¢«è¿‡æ»¤**ï¼š`X-SagaId`ã€`X-ResponseAction`ç­‰è·¨è¿›ç¨‹ä¼ é€’æ—¶ä¸¢å¤±
- âœ… **Dataå­—æ®µå®Œå…¨å¯é **ï¼šä¸å—AOç³»ç»Ÿçš„Tagè¿‡æ»¤å½±å“
- âœ… **æ··åˆç­–ç•¥æœ€ä¼˜**ï¼šActionç”¨Tagï¼ŒSagaä¿¡æ¯ç”¨Data

#### æ•™è®­ #3: ç†è§£AOçš„æ¶ˆæ¯ä¼ é€’æœºåˆ¶
- **`Action` tag**ï¼šç³»ç»Ÿæ ‡å‡†tagï¼Œç”¨äºhandleråŒ¹é…ï¼Œä¸ä¼šè¢«è¿‡æ»¤
- **è‡ªå®šä¹‰tag**ï¼šä¼šè¢«AOçš„`nonForwardableTags`æœºåˆ¶è¿‡æ»¤
- **Dataå­—æ®µ**ï¼šä¸šåŠ¡æ•°æ®è½½ä½“ï¼Œç³»ç»Ÿä¸è§£æä¸è¿‡æ»¤
- **è·¨è¿›ç¨‹é€šä¿¡**ï¼šå¿…é¡»ä½¿ç”¨DataåµŒå…¥ä¼ é€’è‡ªå®šä¹‰åè°ƒä¿¡æ¯

#### æ•™è®­ #4: è°ƒè¯•åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ–¹æ³•è®º
1. âœ… **æ·»åŠ å…¨å±€è°ƒè¯•å˜é‡**ï¼šè®°å½•å…³é”®å‡½æ•°çš„è°ƒç”¨å’Œå‚æ•°
2. âœ… **éªŒè¯æ¶ˆæ¯æ”¶å‘**ï¼šæ£€æŸ¥å‘é€æ–¹å’Œæ¥æ”¶æ–¹çš„å®é™…æ¶ˆæ¯å†…å®¹
3. âœ… **é€æ­¥éªŒè¯å‡è®¾**ï¼šä¸è¦è¿‡æ—©ä¸‹ç»“è®ºï¼Œç”¨å®é™…æµ‹è¯•éªŒè¯æ¯ä¸ªå‡è®¾
4. âœ… **å…³æ³¨æ•°æ®æµ**ï¼šè¿½è¸ªæ•°æ®åœ¨æ•´ä¸ªæµç¨‹ä¸­çš„å˜åŒ–

#### æ•™è®­ #5: ä¸è¦æ··æ·†è¯·æ±‚å’Œå“åº”çš„æ•°æ®ç»“æ„
- **å‘é€è¯·æ±‚æ—¶**ï¼šåµŒå…¥`response_action`å‘Šè¯‰å¯¹æ–¹"æ”¶åˆ°å“åº”åè°ƒç”¨å“ªä¸ªcallback"
- **å‘é€å“åº”æ—¶**ï¼š**ä¸åº”è¯¥**å†åµŒå…¥`response_action`
- **å‘é€å“åº”æ—¶**ï¼šåº”è¯¥å°†è¯·æ±‚ä¸­çš„`response_action`è®¾ç½®ä¸ºå“åº”çš„`Tags.Action`

### ğŸ¯ éªŒè¯ç»“æœ

ä¿®å¤åçš„æµ‹è¯•ç»“æœï¼š
- âœ… **SAGAå®Œå…¨æˆåŠŸ**ï¼šcurrent_step=6, completed=true
- âœ… **åº“å­˜æ­£ç¡®æ›´æ–°**ï¼šä»100æ›´æ–°åˆ°119
- âœ… **æµ‹è¯•å®Œå…¨é€šè¿‡**ï¼š`run-saga-tests.sh`æ‰€æœ‰6ä¸ªæ­¥éª¤æˆåŠŸ
- âœ… **è·¨è¿›ç¨‹é€šä¿¡æ­£å¸¸**ï¼šaliceâ†”bobæ¶ˆæ¯ä¼ é€’æ— è¯¯

### ğŸ“ ä¿®æ”¹æ€»ç»“

**æ ¸å¿ƒä¿®æ”¹**ï¼š
```lua
// src/messaging.lua:114-119
if saga_id then
    data = messaging.embed_saga_info_in_data(data, saga_id, nil)  // åªä¼ é€’saga_id
    message.Data = json.encode(data)
end
```

**å½±å“çš„æ–‡ä»¶**ï¼š
- `src/messaging.lua`: ä¿®å¤`respond`å‡½æ•°
- `ao-cli-non-repl/tests/run-saga-tests.sh`: ä¿®å¤åº“å­˜éªŒè¯é€»è¾‘
- ç§»é™¤æ‰€æœ‰è°ƒè¯•ä»£ç 

### ğŸš€ é•¿æœŸä»·å€¼

è¿™æ¬¡ä¿®å¤ä¸ºAOå¹³å°ä¸Šçš„åˆ†å¸ƒå¼äº‹åŠ¡å®ç°æä¾›äº†å…³é”®æ´å¯Ÿï¼š
1. **DataåµŒå…¥ç­–ç•¥**æ˜¯ç»•è¿‡Tagè¿‡æ»¤çš„æ ‡å‡†æ–¹æ¡ˆ
2. **æ˜ç¡®åŒºåˆ†è¯·æ±‚å’Œå“åº”**çš„Sagaä¿¡æ¯ä¼ é€’æ¨¡å¼
3. **æ··åˆä½¿ç”¨Tagå’ŒData**ï¼šActionç”¨Tagï¼ŒSagaåè°ƒä¿¡æ¯ç”¨Data
4. **å¯ä½œä¸ºDDDMLå·¥å…·**çš„ä»£ç ç”Ÿæˆæ¨¡æ¿å‚è€ƒ

---

**æœ€åæ›´æ–°**: 2025-01-10
**å½“å‰çŠ¶æ€**: âœ… å®Œå…¨è§£å†³ - SAGAè·¨è¿›ç¨‹æ‰§è¡ŒæˆåŠŸ

