-- <autogenerated>
--   This file was generated by dddappp code generator.
--   Any changes made to this file manually will be lost next time the file is regenerated.
-- </autogenerated>

local json = require("json")

-- æµ‹è¯•ä»£ç†åˆçº¦é›†æˆ
local test_proxy_integration = {}

-- åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ
function test_proxy_integration.init()
    -- åŠ è½½å¿…è¦çš„æ¨¡å—
    local saga_messaging = require("saga_messaging")
    local token_transfer_proxy = require("token_transfer_proxy")
    local payment_service = require("payment_service_with_proxy")

    -- åˆå§‹åŒ–ä»£ç†ç³»ç»Ÿ
    saga_messaging.init_proxy_system()

    print("Proxy integration test environment initialized")
    return true
end

-- æµ‹è¯•æ”¯ä»˜æœåŠ¡
function test_proxy_integration.test_payment_service()
    print("\n=== Testing Payment Service with Proxy ===")

    -- æ¨¡æ‹Ÿæ”¯ä»˜è¯·æ±‚æ¶ˆæ¯
    local payment_request = {
        From = "CUSTOMER_PROCESS_ID",
        Tags = {
            Action = "PaymentService_ProcessPayment"
        },
        Data = json.encode({
            order_id = "ORDER_12345",
            customer_address = "CUSTOMER_ADDRESS",
            merchant_address = "MERCHANT_ADDRESS",
            amount = 100,
            payment_method = "ao_token"
        })
    }

    -- è¿™é‡Œå¯ä»¥è°ƒç”¨å®é™…çš„æ”¯ä»˜æœåŠ¡
    -- payment_service.process_payment(payment_request, {}, function() end)

    print("Payment service test initiated (commented out for safety)")
    print("Expected flow:")
    print("1. Payment service creates Saga instance")
    print("2. Saga calls token transfer proxy")
    print("3. Proxy forwards request to AO Token contract")
    print("4. AO Token contract responds with Debit-Notice")
    print("5. Proxy converts response and calls back to Saga")
    print("6. Saga completes payment")

    return true
end

-- æµ‹è¯•ä»£ç†åˆçº¦ç›´æ¥è°ƒç”¨
function test_proxy_integration.test_proxy_contract_direct()
    print("\n=== Testing Proxy Contract Direct Call ===")

    -- æ¨¡æ‹Ÿä»£ç†è°ƒç”¨æ¶ˆæ¯
    local proxy_call_msg = {
        From = "SAGA_MANAGER_PROCESS_ID",
        Tags = {
            Action = "ProxyCall",
            ["X-SagaId"] = "123",
            ["X-CallbackAction"] = "Test_Callback",
            Recipient = "RECIPIENT_ADDRESS",
            Quantity = "50"
        },
        Data = json.encode({
            Recipient = "RECIPIENT_ADDRESS",
            Quantity = "50"
        })
    }

    print("Direct proxy call test initiated")
    print("Expected flow:")
    print("1. Proxy receives call with X-SagaId")
    print("2. Proxy generates request ID and stores mapping")
    print("3. Proxy sends Transfer request to AO Token contract (without X-SagaId)")
    print("4. AO Token contract processes transfer")
    print("5. Proxy receives Debit-Notice and converts to Saga callback")
    print("6. Proxy cleans up request mapping")

    -- è¿™é‡Œå¯ä»¥å®é™…è°ƒç”¨ä»£ç†åˆçº¦
    -- token_transfer_proxy.handle_proxy_call(proxy_call_msg)

    return true
end

-- æµ‹è¯•å“åº”è½¬æ¢
function test_proxy_integration.test_response_adapters()
    print("\n=== Testing Response Adapters ===")

    local response_adapters = require("response_adapters")

    -- æµ‹è¯• Debit-Notice è½¬æ¢
    local debit_msg = {
        From = "TOKEN_CONTRACT_ID",
        Tags = {
            Action = "Debit-Notice",
            Quantity = "100",
            Recipient = "RECIPIENT_ADDRESS",
            ["Message-Id"] = "TX_123"
        },
        Data = "{}"
    }

    local debit_result = response_adapters.ao_token.debit_notice(debit_msg)
    print("Debit-Notice conversion result:")
    print(json.encode(debit_result))

    -- æµ‹è¯• Transfer-Error è½¬æ¢
    local error_msg = {
        From = "TOKEN_CONTRACT_ID",
        Tags = {
            Action = "Transfer-Error",
            Error = "INSUFFICIENT_BALANCE",
            Quantity = "100",
            Recipient = "RECIPIENT_ADDRESS"
        },
        Data = "Insufficient balance for transfer"
    }

    local error_result = response_adapters.ao_token.transfer_error(error_msg)
    print("Transfer-Error conversion result:")
    print(json.encode(error_result))

    return true
end

-- ğŸ”‘ å…³é”®æµ‹è¯•ï¼šè½¬è´¦é‡‘é¢åŒ¹é…å’Œ X-SagaId å…³è”
function test_proxy_integration.test_amount_matching_and_saga_flow()
    print("\n=== Testing Amount Matching and Saga Flow ===")

    local proxy_contract_template = require("proxy_contract_template")
    local messaging = require("messaging")

    -- åˆ›å»ºä»£ç†åˆçº¦å®ä¾‹
    local proxy_config = {
        name = "TestTokenProxy",
        external_config = {
            target = "TOKEN_CONTRACT_ID",
            action = "Transfer",
            response_patterns = {
                success = "Debit-Notice",
                error = "Transfer-Error"
            },
            timeout = 300
        },
        response_adapter = function(msg)
            -- ç®€åŒ–çš„é€‚é…å™¨ç”¨äºæµ‹è¯•
            return { status = "debited", quantity = msg.Tags.Quantity }
        end
    }

    local proxy = proxy_contract_template.create(proxy_config)

    -- æ¨¡æ‹Ÿ Saga è¯·æ±‚ï¼ˆè½¬è´¦ 100 ä¸ª Tokenï¼‰
    local saga_request_msg = {
        From = "SAGA_MANAGER_ID",
        Tags = {
            Action = "ProxyCall",
            ["X-SagaId"] = "SAGA_12345",  -- ğŸ”‘ Saga ID
            ["X-CallbackAction"] = "PaymentService_ProcessPayment_TransferTokens_Callback",
            Quantity = "100",  -- ğŸ”‘ åŸå§‹è½¬è´¦é‡‘é¢
            Recipient = "USER_ADDRESS",
            Sender = "PAYMENT_SERVICE_ID"
        },
        Data = "{}"
    }

    -- è§¦å‘ä»£ç†è°ƒç”¨
    print("1. Initiating proxy call with amount: 100")
    proxy.handle_proxy_call(saga_request_msg)

    -- æ¨¡æ‹Ÿå¤–éƒ¨ Token åˆçº¦çš„æ­£ç¡®å“åº”ï¼ˆé‡‘é¢åŒ¹é…ï¼‰
    local correct_response_msg = {
        From = "TOKEN_CONTRACT_ID",
        Tags = {
            Action = "Debit-Notice",
            ["X-RequestId"] = "REQ_001",  -- è¿™ä¸ªIDä¼šåœ¨å®é™…è¿è¡Œä¸­ç”Ÿæˆ
            Quantity = "100",  -- âœ… é‡‘é¢åŒ¹é…
            Recipient = "USER_ADDRESS",
            ["Message-Id"] = "TX_123"
        },
        Data = "{}"
    }

    print("2. Simulating correct Token contract response (amount matches)")
    proxy.handle_external_response(correct_response_msg)

    -- æ¨¡æ‹Ÿå¤–éƒ¨ Token åˆçº¦çš„é”™è¯¯å“åº”ï¼ˆé‡‘é¢ä¸åŒ¹é…ï¼‰
    local mismatch_response_msg = {
        From = "TOKEN_CONTRACT_ID",
        Tags = {
            Action = "Debit-Notice",
            ["X-RequestId"] = "REQ_002",  -- ä¸åŒçš„è¯·æ±‚ID
            Quantity = "50",   -- âŒ é‡‘é¢ä¸åŒ¹é…ï¼æœŸæœ›100ï¼Œå®é™…50
            Recipient = "USER_ADDRESS",
            ["Message-Id"] = "TX_124"
        },
        Data = "{}"
    }

    print("3. Simulating incorrect Token contract response (amount mismatch: expected 100, got 50)")
    -- é‡æ–°å‘èµ·è¯·æ±‚ä»¥æµ‹è¯•é‡‘é¢ä¸åŒ¹é…çš„æƒ…å†µ
    saga_request_msg.Tags["X-SagaId"] = "SAGA_67890"
    proxy.handle_proxy_call(saga_request_msg)
    proxy.handle_external_response(mismatch_response_msg)

    print("âœ… Amount matching and Saga flow test completed")
    return true
end

-- ğŸ”‘ å…³é”®æµ‹è¯•ï¼šé«˜æ•ˆpendingè¯·æ±‚æŸ¥è¯¢
function test_proxy_integration.test_efficient_pending_queries()
    print("\n=== Testing Efficient Pending Request Queries ===")

    local proxy_contract_template = require("proxy_contract_template")
    local messaging = require("messaging")

    -- åˆ›å»ºä»£ç†åˆçº¦å®ä¾‹
    local proxy_config = {
        name = "TestEfficientProxy",
        external_config = {
            target = "TOKEN_CONTRACT_ID",
            action = "Transfer",
            response_patterns = {
                success = "Debit-Notice",
                error = "Transfer-Error"
            },
            timeout = 300
        },
        response_adapter = function(msg) return { status = "success" } end
    }

    local proxy = proxy_contract_template.create(proxy_config)

    -- æ¨¡æ‹Ÿå¤šä¸ªSagaçš„å¤šä¸ªè¯·æ±‚
    local test_data = {
        { saga_id = "SAGA_001", amount = "100", recipient = "USER_A" },
        { saga_id = "SAGA_001", amount = "200", recipient = "USER_B" }, -- åŒä¸€ä¸ªSagaçš„ç¬¬äºŒä¸ªè¯·æ±‚
        { saga_id = "SAGA_002", amount = "300", recipient = "USER_C" },
        { saga_id = "SAGA_003", amount = "150", recipient = "USER_D" },
    }

    print("1. Creating multiple pending requests...")
    for i, data in ipairs(test_data) do
        local saga_request_msg = {
            From = "SAGA_MANAGER_ID",
            Tags = {
                Action = "ProxyCall",
                ["X-SagaId"] = data.saga_id,
                ["X-CallbackAction"] = "Callback_" .. i,
                Quantity = data.amount,
                Recipient = data.recipient
            },
            Data = "{}"
        }

        -- è¿™é‡Œä¼šè°ƒç”¨proxy.handle_proxy_callï¼Œåˆ›å»ºpendingè¯·æ±‚å¹¶å»ºç«‹ç´¢å¼•
        proxy.handle_proxy_call(saga_request_msg)
    end

    -- æµ‹è¯•é«˜æ•ˆæŸ¥è¯¢ï¼šæŒ‰saga_idæŸ¥æ‰¾ - O(1)å¤æ‚åº¦ï¼Œä¸éœ€è¦éå†
    print("2. Testing O(1) saga_id queries...")
    local saga001_requests = proxy.find_requests_by_saga_id("SAGA_001")
    print(string.format("   SAGA_001 has %d pending requests", count_keys(saga001_requests)))
    assert(count_keys(saga001_requests) == 2, "Should find 2 requests for SAGA_001")

    local saga002_requests = proxy.find_requests_by_saga_id("SAGA_002")
    print(string.format("   SAGA_002 has %d pending requests", count_keys(saga002_requests)))
    assert(count_keys(saga002_requests) == 1, "Should find 1 request for SAGA_002")

    local non_existent_requests = proxy.find_requests_by_saga_id("NON_EXISTENT")
    print(string.format("   NON_EXISTENT has %d pending requests", count_keys(non_existent_requests)))
    assert(count_keys(non_existent_requests) == 0, "Should find 0 requests for non-existent saga")

    -- æµ‹è¯•é«˜æ•ˆæŸ¥è¯¢ï¼šæŒ‰external_targetæŸ¥æ‰¾ - O(1)å¤æ‚åº¦
    print("3. Testing O(1) external_target queries...")
    local target_requests = proxy.find_requests_by_external_target("TOKEN_CONTRACT_ID")
    print(string.format("   TOKEN_CONTRACT_ID has %d pending requests", count_keys(target_requests)))
    assert(count_keys(target_requests) == 4, "Should find 4 requests for TOKEN_CONTRACT_ID")

    -- æµ‹è¯•è·å–å®Œæ•´è¯·æ±‚è¯¦æƒ…
    print("4. Testing get_pending_requests_for_saga...")
    local saga001_details = proxy.get_pending_requests_for_saga("SAGA_001")
    print(string.format("   SAGA_001 details contain %d request objects", count_keys(saga001_details)))
    assert(count_keys(saga001_details) == 2, "Should get 2 detailed request objects")

    -- éªŒè¯é‡‘é¢ä¿¡æ¯è¢«æ­£ç¡®å­˜å‚¨
    local found_100 = false
    local found_200 = false
    for request_id, request_info in pairs(saga001_details) do
        if request_info.original_quantity == "100" then found_100 = true end
        if request_info.original_quantity == "200" then found_200 = true end
    end
    assert(found_100 and found_200, "Should find both 100 and 200 amount requests")

    -- æµ‹è¯•å–æ¶ˆåŠŸèƒ½ - é«˜æ•ˆåœ°å–æ¶ˆæ•´ä¸ªSagaçš„æ‰€æœ‰è¯·æ±‚
    print("5. Testing cancel_saga_requests (efficient bulk cancellation)...")
    local cancelled_count = proxy.cancel_saga_requests("SAGA_001", "Test cancellation")
    print(string.format("   Cancelled %d requests for SAGA_001", cancelled_count))
    assert(cancelled_count == 2, "Should cancel 2 requests for SAGA_001")

    -- éªŒè¯å–æ¶ˆåçš„æŸ¥è¯¢ç»“æœ
    local saga001_after_cancel = proxy.find_requests_by_saga_id("SAGA_001")
    print(string.format("   SAGA_001 has %d pending requests after cancellation", count_keys(saga001_after_cancel)))
    assert(count_keys(saga001_after_cancel) == 0, "Should have 0 requests after cancellation")

    print("âœ… Efficient pending request queries test completed")
    return true
end

-- ğŸ”‘ æ ¸å¿ƒæµ‹è¯•ï¼šé€šè¿‡é‡‘é¢åŒ¹é…æœç´¢pendingè¯·æ±‚å¹¶è§¦å‘Sagaæµç¨‹
function test_proxy_integration.test_amount_matching_saga_flow()
    print("\n=== Testing Amount Matching and Saga Flow Triggering ===")

    local proxy_contract_template = require("proxy_contract_template")
    local messaging = require("messaging")

    -- åˆ›å»ºä»£ç†åˆçº¦å®ä¾‹
    local proxy_config = {
        name = "TestAmountMatchingProxy",
        external_config = {
            target = "TOKEN_CONTRACT_ID",
            action = "Transfer",
            response_patterns = {
                success = "Debit-Notice",
                error = "Transfer-Error"
            },
            timeout = 300
        },
        response_adapter = function(msg) return { status = "debited", quantity = msg.Tags.Quantity } end
    }

    local proxy = proxy_contract_template.create(proxy_config)

    -- æ¨¡æ‹Ÿä¸¤ä¸ªä¸åŒçš„è½¬è´¦è¯·æ±‚
    local requests = {
        { saga_id = "SAGA_001", amount = "100", recipient = "USER_A", callback = "Callback_A" },
        { saga_id = "SAGA_002", amount = "200", recipient = "USER_B", callback = "Callback_B" },
        { saga_id = "SAGA_003", amount = "100", recipient = "USER_C", callback = "Callback_C" }, -- ç›¸åŒé‡‘é¢ä¸åŒæ¥æ”¶æ–¹
    }

    print("1. Creating pending requests with business parameters...")
    for i, req in ipairs(requests) do
        local saga_request_msg = {
            From = "SAGA_MANAGER_ID",
            Tags = {
                Action = "ProxyCall",
                ["X-SagaId"] = req.saga_id,
                ["X-CallbackAction"] = req.callback,
                Quantity = req.amount,
                Recipient = req.recipient
            },
            Data = "{}"
        }

        -- åˆ›å»ºpendingè¯·æ±‚ï¼Œè¿™ä¼šå»ºç«‹ä¸šåŠ¡å‚æ•°ç´¢å¼•
        proxy.handle_proxy_call(saga_request_msg)
        print(string.format("   Created request: saga=%s, amount=%s, recipient=%s",
            req.saga_id, req.amount, req.recipient))
    end

    -- æµ‹è¯•é€šè¿‡é‡‘é¢æŸ¥æ‰¾
    print("\n2. Testing amount-based search...")
    local amount_100_requests = proxy.find_requests_by_amount("100")
    print(string.format("   Found %d requests with amount=100", count_keys(amount_100_requests)))
    assert(count_keys(amount_100_requests) == 2, "Should find 2 requests with amount 100")

    -- æµ‹è¯•ç²¾ç¡®åŒ¹é…ï¼šé‡‘é¢+æ¥æ”¶æ–¹
    print("\n3. Testing exact business parameter matching...")
    local exact_match = proxy.find_request_by_business_params("100", "USER_A")
    assert(exact_match ~= nil, "Should find exact match for amount=100, recipient=USER_A")
    assert(exact_match.saga_id == "SAGA_001", "Should match correct saga")
    print("   âœ… Exact match found: saga=SAGA_001 for amount=100, recipient=USER_A")

    -- ğŸ”‘ æ ¸å¿ƒæ¼”ç¤ºï¼šæ¨¡æ‹Ÿå¤–éƒ¨å“åº”ï¼ˆä¸åŒ…å«X-RequestIdï¼‰ï¼Œé€šè¿‡é‡‘é¢åŒ¹é…æ‰¾åˆ°å¯¹åº”è¯·æ±‚
    print("\n4. ğŸ”‘ Core Demo: External response matching by amount...")

    -- æ¨¡æ‹ŸTokenåˆçº¦å“åº” - æ³¨æ„ï¼šä¸åŒ…å«X-RequestIdï¼
    local external_response = {
        From = "TOKEN_CONTRACT_ID",
        Tags = {
            Action = "Debit-Notice",
            Quantity = "100",        -- ğŸ”‘ é€šè¿‡é‡‘é¢åŒ¹é…
            Recipient = "USER_A",    -- ğŸ”‘ é€šè¿‡æ¥æ”¶æ–¹åŒ¹é…
            ["Message-Id"] = "TX_123"
        },
        Data = "{}"
    }

    print("   Simulating external response WITHOUT X-RequestId:")
    print("   - Amount: 100")
    print("   - Recipient: USER_A")
    print("   - Expected to match: SAGA_001")

    -- è°ƒç”¨å“åº”å¤„ç†å™¨ - è¿™ä¼šé€šè¿‡ä¸šåŠ¡å‚æ•°åŒ¹é…æ‰¾åˆ°å¯¹åº”çš„pendingè¯·æ±‚
    proxy.handle_external_response(external_response)

    -- éªŒè¯ï¼šå¯¹åº”çš„è¯·æ±‚åº”è¯¥å·²ç»è¢«å¤„ç†å’Œæ¸…ç†
    local after_match = proxy.find_request_by_business_params("100", "USER_A")
    assert(after_match == nil, "Request should be cleaned up after successful matching")
    print("   âœ… Request successfully matched and cleaned up")

    -- éªŒè¯å…¶ä»–è¯·æ±‚ä»ç„¶å­˜åœ¨
    local saga002_still_exists = proxy.find_request_by_business_params("200", "USER_B")
    assert(saga002_still_exists ~= nil, "Other requests should still exist")
    print("   âœ… Other requests remain untouched")

    -- ğŸ”‘ æœ€ç»ˆéªŒè¯ï¼šé€šè¿‡é‡‘é¢æ‰¾åˆ°X-SagaIdå¹¶ç»§ç»­æµç¨‹
    print("\n5. ğŸ”‘ Final Verification: Finding X-SagaId through amount matching...")

    -- æ¨¡æ‹Ÿå¦ä¸€ä¸ªå“åº”ï¼Œé€šè¿‡é‡‘é¢æ‰¾åˆ°å¯¹åº”çš„Saga
    local another_response = {
        From = "TOKEN_CONTRACT_ID",
        Tags = {
            Action = "Debit-Notice",
            Quantity = "200",        -- è¿™ä¸ªé‡‘é¢å¯¹åº”SAGA_002
            Recipient = "USER_B",
            ["Message-Id"] = "TX_456"
        },
        Data = "{}"
    }

    -- é€šè¿‡ä¸šåŠ¡å‚æ•°æŸ¥æ‰¾å¯¹åº”çš„è¯·æ±‚ä¿¡æ¯
    local matched_request = proxy.find_request_by_business_params("200", "USER_B")
    assert(matched_request ~= nil, "Should find the request")
    assert(matched_request.saga_id == "SAGA_002", "Should find correct saga")

    print("   âœ… Found X-SagaId through amount matching:")
    print(string.format("      Amount: 200 â†’ Saga ID: %s", matched_request.saga_id))
    print(string.format("      Callback Action: %s", matched_request.callback_action))

    -- æ¨¡æ‹Ÿå®Œæ•´çš„å“åº”å¤„ç†
    proxy.handle_external_response(another_response)

    -- éªŒè¯Sagaæµç¨‹è¢«æ­£ç¡®è§¦å‘ï¼ˆè¯·æ±‚è¢«æ¸…ç†ï¼‰
    local final_check = proxy.find_request_by_business_params("200", "USER_B")
    assert(final_check == nil, "Saga flow should be triggered and request cleaned up")

    print("   âœ… Saga flow successfully triggered through amount matching!")

    print("\nâœ… Amount matching saga flow test completed")
    return true
end

-- ğŸ”‘ è¾¹ç•Œæƒ…å†µæµ‹è¯•ï¼šé‡å¤æ¶ˆæ¯ã€å†…å­˜é™åˆ¶ã€å¹‚ç­‰æ€§
function test_proxy_integration.test_boundary_cases_and_safety()
    print("\n=== Testing Boundary Cases and Safety Measures ===")

    local proxy_contract_template = require("proxy_contract_template")
    local messaging = require("messaging")

    -- åˆ›å»ºä»£ç†åˆçº¦å®ä¾‹
    local proxy_config = {
        name = "TestBoundaryCasesProxy",
        external_config = {
            target = "TOKEN_CONTRACT_ID",
            action = "Transfer",
            response_patterns = {
                success = "Debit-Notice",
                error = "Transfer-Error"
            },
            timeout = 300
        },
        response_adapter = function(msg) return { status = "success" } end
    }

    local proxy = proxy_contract_template.create(proxy_config)

    -- æµ‹è¯•1ï¼šé‡å¤æ¶ˆæ¯å¤„ç†ï¼ˆå¹‚ç­‰æ€§ï¼‰
    print("1. Testing duplicate message handling...")
    local saga_request_msg = {
        From = "SAGA_MANAGER_ID",
        Tags = {
            Action = "ProxyCall",
            ["X-SagaId"] = "SAGA_DUPLICATE_TEST",
            ["X-CallbackAction"] = "Callback_Duplicate",
            Quantity = "500",
            Recipient = "USER_DUPLICATE"
        },
        Data = "{}"
    }

    -- åˆ›å»ºåˆå§‹è¯·æ±‚
    proxy.handle_proxy_call(saga_request_msg)

    -- æ¨¡æ‹Ÿç¬¬ä¸€æ¬¡å“åº”
    local first_response = {
        From = "TOKEN_CONTRACT_ID",
        Tags = {
            Action = "Debit-Notice",
            ["X-RequestId"] = "REQ_001",
            Quantity = "500",
            Recipient = "USER_DUPLICATE"
        },
        Data = "{}"
    }

    print("   Sending first response...")
    proxy.handle_external_response(first_response)

    -- æ¨¡æ‹Ÿé‡å¤å“åº”ï¼ˆç›¸åŒçš„è¯·æ±‚IDï¼‰
    print("   Sending duplicate response (same request ID)...")
    proxy.handle_external_response(first_response)  -- åº”è¯¥è¢«å¿½ç•¥

    -- æµ‹è¯•2ï¼šå†…å­˜é™åˆ¶
    print("\n2. Testing memory limits...")
    -- åˆ›å»ºå¤§é‡è¯·æ±‚æ¥æµ‹è¯•å†…å­˜é™åˆ¶
    for i = 1, 50 do
        local bulk_request = {
            From = "SAGA_MANAGER_ID",
            Tags = {
                Action = "ProxyCall",
                ["X-SagaId"] = "SAGA_BULK_" .. i,
                ["X-CallbackAction"] = "Callback_Bulk_" .. i,
                Quantity = tostring(100 + i),
                Recipient = "USER_BULK_" .. i
            },
            Data = "{}"
        }
        proxy.handle_proxy_call(bulk_request)
    end

    print("   Created 50 requests, testing memory enforcement...")
    proxy.enforce_memory_limits()  -- åº”è¯¥è§¦å‘æ¸…ç†

    -- æµ‹è¯•3ï¼šä¸šåŠ¡å‚æ•°ä¸å®Œæ•´çš„æƒ…å†µ
    print("\n3. Testing incomplete business parameters...")
    local incomplete_response = {
        From = "TOKEN_CONTRACT_ID",
        Tags = {
            Action = "Debit-Notice",
            Quantity = "300"  -- ç¼ºå°‘Recipient
        },
        Data = "{}"
    }

    print("   Sending response with incomplete parameters...")
    proxy.handle_external_response(incomplete_response)  -- åº”è¯¥è¢«æ‹’ç»

    -- æµ‹è¯•4ï¼šæ— åŒ¹é…è¯·æ±‚çš„æƒ…å†µ
    print("\n4. Testing no matching request...")
    local no_match_response = {
        From = "TOKEN_CONTRACT_ID",
        Tags = {
            Action = "Debit-Notice",
            Quantity = "999999",  -- ä¸å­˜åœ¨çš„é‡‘é¢
            Recipient = "NON_EXISTENT_USER"
        },
        Data = "{}"
    }

    print("   Sending response with no matching request...")
    proxy.handle_external_response(no_match_response)  -- åº”è¯¥è¢«è®°å½•ä½†å¿½ç•¥

    print("\nâœ… Boundary cases and safety measures test completed")
    return true
end

-- è¾…åŠ©å‡½æ•°ï¼šè®¡ç®—tableä¸­keyçš„æ•°é‡
function count_keys(tbl)
    local count = 0
    for _ in pairs(tbl) do
        count = count + 1
    end
    return count
end

-- æµ‹è¯• Saga å·¥å…·å‡½æ•°
function test_proxy_integration.test_saga_tools()
    print("\n=== Testing Saga Tools ===")

    local saga_messaging = require("saga_messaging")

    -- æ³¨å†Œæµ‹è¯•ä»£ç†åˆçº¦
    local test_proxy = saga_messaging.register_proxy_contract("test_proxy", {
        name = "TestProxy",
        external_config = {
            target = "TEST_EXTERNAL_CONTRACT",
            action = "TestAction"
        }
    })

    print("Test proxy registered successfully")

    -- æµ‹è¯•è·å–ä»£ç†åˆçº¦
    local retrieved_proxy = saga_messaging.get_proxy_contract("test_proxy")
    assert(retrieved_proxy == test_proxy, "Proxy retrieval failed")

    print("Proxy retrieval test passed")

    return true
end

-- è¿è¡Œæ‰€æœ‰æµ‹è¯•
function test_proxy_integration.run_all_tests()
    print("Starting Proxy Integration Tests...")

    local results = {}

    results.init = test_proxy_integration.init()
    results.adapters = test_proxy_integration.test_response_adapters()
    results.amount_matching = test_proxy_integration.test_amount_matching_and_saga_flow()  -- ğŸ”‘ æ–°å¢å…³é”®æµ‹è¯•
    results.efficient_queries = test_proxy_integration.test_efficient_pending_queries()  -- ğŸ”‘ æ–°å¢é«˜æ•ˆæŸ¥è¯¢æµ‹è¯•
    results.core_amount_saga = test_proxy_integration.test_amount_matching_saga_flow()  -- ğŸ”‘ æ ¸å¿ƒï¼šé‡‘é¢åŒ¹é…è§¦å‘Sagaæµç¨‹
    results.boundary_cases = test_proxy_integration.test_boundary_cases_and_safety()  -- ğŸ”‘ è¾¹ç•Œæƒ…å†µå’Œå®‰å…¨æµ‹è¯•
    results.payment = test_proxy_integration.test_payment_service()
    results.proxy_direct = test_proxy_integration.test_proxy_contract_direct()
    results.saga_tools = test_proxy_integration.test_saga_tools()

    print("\n=== Test Results ===")
    local all_passed = true
    for test_name, result in pairs(results) do
        local status = result and "PASS" or "FAIL"
        print(string.format("%-15s: %s", test_name, status))
        if not result then
            all_passed = false
        end
    end

    print("\nOverall result: " .. (all_passed and "ALL TESTS PASSED" or "SOME TESTS FAILED"))

    return all_passed
end

-- å¯¼å‡ºæµ‹è¯•æ¨¡å—
return test_proxy_integration
