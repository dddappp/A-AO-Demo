-- <autogenerated>
--   This file demonstrates the suggested extensions to src/saga_messaging.lua
--   These are NOT actual modifications to the original file, but rather
--   conceptual examples of how to extend the saga messaging system.
-- </autogenerated>

-- ===== SAGA_MESSAGING.LUA æ‰©å±•ç¤ºä¾‹ =====
-- æ­¤æ–‡ä»¶å±•ç¤ºäº†å¯¹ src/saga_messaging.lua çš„å»ºè®®æ‰©å±•å†…å®¹
-- å®é™…ä½¿ç”¨æ—¶ï¼Œè¯·æ‰‹åŠ¨å°†è¿™äº›ä»£ç æ·»åŠ åˆ° src/saga_messaging.lua çš„ç›¸åº”ä½ç½®

-- æ³¨æ„ï¼šè¿™äº›æ‰©å±•å‡è®¾åœ¨ src/saga_messaging.lua çš„é¡¶éƒ¨å·²ç»æœ‰äº†ï¼š
-- local saga = require("saga")
-- local messaging = require("messaging")
-- local json = require("json")  -- éœ€è¦æ·»åŠ è¿™ä¸€è¡Œ

-- ===== å»ºè®®çš„æ‰©å±•å†…å®¹ï¼ˆæ·»åŠ åˆ° src/saga_messaging.lua æ–‡ä»¶æœ«å°¾ï¼‰=====

-- ä»£ç†åˆçº¦æ³¨å†Œè¡¨
local proxy_registry = {}

-- æ³¨å†Œä»£ç†åˆçº¦å®ä¾‹
-- è¿™ä¸ªå‡½æ•°å…è®¸æ³¨å†Œä»£ç†åˆçº¦å®ä¾‹åˆ°è¿è¡Œæ—¶æ³¨å†Œè¡¨ä¸­
function saga_messaging.register_proxy_contract(name, proxy_instance)
    proxy_registry[name] = proxy_instance
    return proxy_instance
end

-- è·å–ä»£ç†åˆçº¦å®ä¾‹
-- æ ¹æ®åç§°è·å–å·²æ³¨å†Œçš„ä»£ç†åˆçº¦å®ä¾‹
function saga_messaging.get_proxy_contract(name)
    return proxy_registry[name]
end

-- åˆ›å»ºä»£ç†æ­¥éª¤çš„ Saga å®ä¾‹
-- è¿™æ˜¯ä¸€ä¸ªé«˜çº§å·¥å…·å‡½æ•°ï¼Œç”¨äºåˆ›å»ºåŒ…å«ä»£ç†æ­¥éª¤çš„ Saga å®ä¾‹
-- å‚æ•°è¯´æ˜ï¼š
--   saga_type: Saga ç±»å‹æ ‡è¯†ç¬¦
--   proxy_contract_name: å·²æ³¨å†Œçš„ä»£ç†åˆçº¦åç§°
--   external_call_config: å¤–éƒ¨è°ƒç”¨é…ç½®ï¼ŒåŒ…å« callback_action ç­‰
--   context: Saga ä¸Šä¸‹æ–‡æ•°æ®
--   original_message: åŸå§‹è¯·æ±‚æ¶ˆæ¯
function saga_messaging.create_proxy_step_saga(saga_type, proxy_contract_name, external_call_config, context, original_message)
    -- è·å–ä»£ç†åˆçº¦å®ä¾‹
    local proxy_contract = proxy_registry[proxy_contract_name]
    if not proxy_contract then
        error("Proxy contract not found: " .. proxy_contract_name)
    end

    -- è·å–ä»£ç†åˆçº¦çš„ç›®æ ‡åœ°å€
    local proxy_target = proxy_contract.config.external_config.target

    -- æ„å»ºå‘é€ç»™ä»£ç†åˆçº¦çš„æ¶ˆæ¯æ ‡ç­¾
    local proxy_tags = {
        Action = "ProxyCall",  -- å›ºå®šåŠ¨ä½œï¼Œè¡¨ç¤ºè¿™æ˜¯ä»£ç†è°ƒç”¨
        ["X-CallbackAction"] = external_call_config.callback_action,  -- æŒ‡å®šå›è°ƒåŠ¨ä½œ
    }

    -- åˆ›å»º Saga å®ä¾‹ï¼Œç›®æ ‡æ˜¯ä»£ç†åˆçº¦
    local saga_instance, commit = saga.create_saga_instance(
        saga_type,           -- Saga ç±»å‹
        proxy_target,        -- ç›®æ ‡åœ°å€ï¼ˆä»£ç†åˆçº¦ï¼‰
        proxy_tags,          -- æ¶ˆæ¯æ ‡ç­¾
        context,             -- ä¸Šä¸‹æ–‡æ•°æ®
        original_message,    -- åŸå§‹æ¶ˆæ¯
        0                    -- ä¸é¢„ç•™æœ¬åœ°æ­¥éª¤ï¼Œå› ä¸ºè¿™æ˜¯å¤–éƒ¨è°ƒç”¨
    )

    return saga_instance, commit
end

-- æ‰§è¡Œä»£ç†è¡¥å¿
-- å¤„ç†ä»£ç†åˆçº¦çš„è¡¥å¿é€»è¾‘
function saga_messaging.execute_proxy_compensation(saga_instance, compensation_config, _err)
    local compensation_type = compensation_config.type
    local proxy_contract_name = compensation_config.proxy_contract

    -- è·å–ä»£ç†åˆçº¦å®ä¾‹
    local proxy_contract = proxy_registry[proxy_contract_name]
    if not proxy_contract then
        error("Proxy contract not found for compensation: " .. proxy_contract_name)
    end

    -- ğŸ”‘ æ ¸å¿ƒï¼šè¿”å›ä»£ç†è¡¥å¿å‡½æ•°ï¼ˆä¸ç«‹å³æ‰§è¡Œï¼‰
    local compensation_handler = proxy_contract.config.compensation_handler[compensation_type]

    if not compensation_handler then
        error("Compensation handler not found for type: " .. compensation_type)
    end

    -- è¿”å›è¡¥å¿å‡½æ•°ï¼Œç”±è°ƒç”¨æ–¹å†³å®šä½•æ—¶æ‰§è¡Œ
    return function()
        -- æ‰§è¡Œè¡¥å¿é€»è¾‘
        print("Executing proxy compensation: " .. compensation_type .. " for saga: " .. saga_instance.saga_id)

        -- è°ƒç”¨ä»£ç†åˆçº¦çš„è¡¥å¿å¤„ç†å™¨
        local compensation_request = compensation_handler(compensation_config.compensation_data or {})

        if compensation_request then
            -- å‘é€è¡¥å¿è¯·æ±‚åˆ°å¤–éƒ¨åˆçº¦
            ao.send({
                Target = proxy_contract.config.external_config.target,
                Tags = {
                    Action = compensation_request.action,
                    ["X-CompensationSagaId"] = saga_instance.saga_id,
                    ["X-CompensationType"] = compensation_type
                },
                Data = json.encode(compensation_request.data or {})
            })
            print("Sent compensation request to external contract: " .. compensation_request.action)
        else
            print("Compensation handler returned no action (no compensation needed)")
        end
    end
end

-- ä»£ç†å“åº”å¤„ç†å™¨å·¥å‚
-- åˆ›å»ºä¸€ä¸ªå¤„ç†å™¨å‡½æ•°æ¥å¤„ç†ä»£ç†åˆçº¦çš„å¼‚æ­¥å“åº”
-- è¿™æ˜¯ä¸€ä¸ªå·¥å‚å‡½æ•°ï¼Œè¿”å›å®é™…çš„å¤„ç†å™¨å‡½æ•°
function saga_messaging.create_proxy_response_handler(proxy_contract_name, success_callback, error_callback)
    return function(msg)
        -- è·å–ä»£ç†åˆçº¦å®ä¾‹
        local proxy_contract = proxy_registry[proxy_contract_name]
        if not proxy_contract then
            error("Proxy contract not found: " .. proxy_contract_name)
        end

        -- è§£æå“åº”æ•°æ®ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
        local data = {}
        local decode_success, decode_result = pcall(function()
            return json.decode(msg.Data or "{}")
        end)

        if decode_success then
            data = decode_result
        else
            print("Failed to decode proxy response data: " .. decode_result)
            data = { error = "JSON_DECODE_ERROR", message = decode_result }
        end

        -- æ ¹æ®å“åº”ç±»å‹è°ƒç”¨ç›¸åº”çš„å›è°ƒå‡½æ•°
        if data.error then
            -- é”™è¯¯å“åº”
            if error_callback then
                error_callback(data.error, msg)
            end
        elseif data.result then
            -- æˆåŠŸå“åº”
            if success_callback then
                success_callback(data.result, msg)
            end
        else
            -- æœªçŸ¥å“åº”ç±»å‹
            print("Warning: Received unknown response type from proxy contract: " .. proxy_contract_name)
        end
    end
end

-- åˆå§‹åŒ–ä»£ç†ç³»ç»Ÿ
-- å¯é€‰çš„åˆå§‹åŒ–å‡½æ•°ï¼Œç”¨äºä»£ç†ç³»ç»Ÿçš„è®¾ç½®
function saga_messaging.init_proxy_system()
    -- å¯ä»¥åœ¨è¿™é‡Œè¿›è¡Œä»£ç†ç³»ç»Ÿçš„åˆå§‹åŒ–
    -- ä¾‹å¦‚ï¼šè®¾ç½®å…¨å±€é…ç½®ã€é¢„æ³¨å†Œå¸¸ç”¨ä»£ç†åˆçº¦ç­‰

    print("Proxy system initialized")

    -- ç¤ºä¾‹ï¼šå¯ä»¥åœ¨è¿™é‡Œé¢„æ³¨å†Œä¸€äº›å¸¸ç”¨çš„ä»£ç†åˆçº¦
    -- local token_proxy = require("token_proxy_config")
    -- saga_messaging.register_proxy_contract("default_token", token_proxy)
end

-- è·å–ä»£ç†è¡¥å¿å‡½æ•°ï¼ˆä¸ç«‹å³æ‰§è¡Œï¼‰
function saga_messaging.get_proxy_compensation_function(saga_instance, compensation_config, _err)
    local proxy_contract_name = compensation_config.proxy_contract
    local compensation_type = compensation_config.type

    local proxy_contract = proxy_registry[proxy_contract_name]
    if not proxy_contract then
        error("Proxy contract not found for compensation: " .. proxy_contract_name)
    end

    -- ğŸ”‘ æ ¸å¿ƒï¼šè¿”å›ä»£ç†è¡¥å¿å‡½æ•°ï¼ˆä¸ç«‹å³æ‰§è¡Œï¼‰
    local compensation_handler = proxy_contract.config.compensation_handler[compensation_type]

    if not compensation_handler then
        error("Compensation handler not found for type: " .. compensation_type)
    end

    -- è¿”å›è¡¥å¿å‡½æ•°ï¼Œç”±è°ƒç”¨æ–¹å†³å®šä½•æ—¶æ‰§è¡Œ
    return function()
        -- æ‰§è¡Œè¡¥å¿é€»è¾‘
        print("Executing proxy compensation: " .. compensation_type .. " for saga: " .. saga_instance.saga_id)

        -- è°ƒç”¨ä»£ç†åˆçº¦çš„è¡¥å¿å¤„ç†å™¨
        local compensation_request = compensation_handler(compensation_config.compensation_data or {})

        if compensation_request then
            -- å‘é€è¡¥å¿è¯·æ±‚åˆ°å¤–éƒ¨åˆçº¦
            ao.send({
                Target = proxy_contract.config.external_config.target,
                Tags = {
                    Action = compensation_request.action,
                    ["X-CompensationSagaId"] = saga_instance.saga_id,
                    ["X-CompensationType"] = compensation_type
                },
                Data = json.encode(compensation_request.data or {})
            })
            print("Sent compensation request to external contract: " .. compensation_request.action)
        else
            print("Compensation handler returned no action (no compensation needed)")
        end
    end
end

-- ===== æ‰©å±•å†…å®¹ç»“æŸ =====

-- ===== ä½¿ç”¨ç¤ºä¾‹ =====
-- ä»¥ä¸‹æ˜¯è¿™äº›æ‰©å±•å‡½æ•°çš„ä½¿ç”¨ç¤ºä¾‹ï¼ˆè¿™äº›ä»£ç ä¸ä¼šå®é™…è¿è¡Œï¼Œåªåšæ¼”ç¤ºï¼‰

-- ç¤ºä¾‹1ï¼šæ³¨å†Œä»£ç†åˆçº¦
-- local token_proxy = require("token_transfer_proxy")
-- saga_messaging.register_proxy_contract("token_transfer", token_proxy)

-- ç¤ºä¾‹2ï¼šåˆ›å»ºåŒ…å«ä»£ç†æ­¥éª¤çš„ Saga
-- function create_payment_saga(payment_request)
--     local saga_instance, commit = saga_messaging.create_proxy_step_saga(
--         "PAYMENT_SAGA",
--         "token_transfer",  -- ä»£ç†åˆçº¦åç§°
--         {
--             callback_action = "PaymentService_ProcessPayment_TransferTokens_Callback"
--         },
--         {
--             amount = payment_request.amount,
--             recipient = payment_request.merchant_address
--         },
--         payment_request  -- åŸå§‹æ¶ˆæ¯
--     )
--
--     -- æäº¤ Saga åˆ›å»º
--     commit()
-- end

-- ç¤ºä¾‹3ï¼šåˆ›å»ºå“åº”å¤„ç†å™¨
-- local response_handler = saga_messaging.create_proxy_response_handler(
--     "token_transfer",
--     function(result, msg) print("Transfer successful:", result.transaction_id) end,
--     function(error, msg) print("Transfer failed:", error) end
-- )

-- ç¤ºä¾‹4ï¼šåˆå§‹åŒ–ä»£ç†ç³»ç»Ÿ
-- saga_messaging.init_proxy_system()

print("This file demonstrates the suggested extensions to saga_messaging.lua")
print("DO NOT load or execute this file in production - it is for documentation only")
