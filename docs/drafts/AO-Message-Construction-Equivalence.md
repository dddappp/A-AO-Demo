# AO æ¶ˆæ¯æ„é€ ç­‰ä»·æ€§å‘ç°

**æ—¥æœŸ**: 2025-10-19
**å‘ç°è€…**: AI Assistant
**éªŒè¯**: é€šè¿‡ AO ä»£ç åº“æºç åˆ†æ

## ğŸ¯ æ ¸å¿ƒå‘ç°

åœ¨ AO ç³»ç»Ÿä¸­ï¼Œä»¥ä¸‹ä¸¤ç§æ¶ˆæ¯æ„é€ æ–¹å¼æ˜¯**å®Œå…¨ç­‰ä»·**çš„ï¼š

```lua
-- æ–¹å¼1: ç›´æ¥å±æ€§
Send({Target = ao.id, Action = "GetArticleIdSequence"})

-- æ–¹å¼2: Tags å¯¹è±¡
Send({Target = ao.id, Tags = {Action = "GetArticleIdSequence"}})
```

ä¸¤ç§æ–¹å¼æœ€ç»ˆéƒ½äº§ç”Ÿç›¸åŒçš„æ¶ˆæ¯ç»“æ„ï¼Œå¯¹ Handler åŒ¹é…è¡Œä¸ºå®Œå…¨ä¸€è‡´ã€‚

## ğŸ” æŠ€æœ¯æœºåˆ¶åˆ†æ

### AO æ¶ˆæ¯å¤„ç†æµç¨‹

#### å‘é€ç«¯ï¼šåŒå‘åŒæ­¥åˆ° Tags æ•°ç»„
1. **æ ¹éƒ¨å±æ€§ â†’ Tags æ•°ç»„**: AO çš„ `send()` å‡½æ•°å°†æ¶ˆæ¯æ ¹éƒ¨å±æ€§è½¬æ¢ä¸º Tags
2. **Tags å¯¹è±¡ â†’ Tags æ•°ç»„**: æ”¯æŒå¯¹è±¡æ ¼å¼çš„ Tags è¾“å…¥

#### æ¥æ”¶ç«¯ï¼šå•å‘åŒæ­¥åˆ°æ¶ˆæ¯ç»“æ„
3. **Tags æ•°ç»„ â†’ æ¶ˆæ¯æ ¹éƒ¨**: `ao.normalize()` å°†å…è®¸çš„ Tags æå–åˆ°æ¶ˆæ¯æ ¹éƒ¨
4. **Tags æ•°ç»„ â†’ Tags å¯¹è±¡**: `Tab()` å‡½æ•°åˆ›å»º key-value æ ¼å¼çš„ Tags
5. **Handler åŒ¹é…**: åŸºäºæ ‡å‡†åŒ–åçš„æ¶ˆæ¯è¿›è¡ŒåŒ¹é…

### å…³é”®ä»£ç ï¼šå‘é€ç«¯åŒæ­¥

ä½ç½®: `/PATH/TO/permaweb/ao/dev-cli/src/starters/lua/ao.lua`

**æ ¹éƒ¨å±æ€§ â†’ Tags æ•°ç»„**:
```lua
-- if custom tags in root move them to tags
for k, v in pairs(msg) do
    if not _includes({"Target", "Data", "Anchor", "Tags", "From"})(k) then
        table.insert(message.Tags, {name = k, value = v})
    end
end
```

**Tags å¯¹è±¡ â†’ Tags æ•°ç»„**:
```lua
if msg.Tags then
    if isArray(msg.Tags) then
        for _, o in ipairs(msg.Tags) do
            table.insert(message.Tags, o)
        end
    else
        for k, v in pairs(msg.Tags) do
            table.insert(message.Tags, {name = k, value = v})
        end
    end
end
```

### å…³é”®ä»£ç ï¼šæ¥æ”¶ç«¯åŒæ­¥

**Tags æ•°ç»„ â†’ æ¶ˆæ¯æ ¹éƒ¨**:
```lua
function ao.normalize(msg)
    for _, o in ipairs(msg.Tags) do
        if not _includes(ao.nonExtractableTags)(o.name) then
            msg[o.name] = o.value  -- å°† Tag æå–åˆ°æ¶ˆæ¯æ ¹éƒ¨
        end
    end
    return msg
end
```

**Tags æ•°ç»„ â†’ Tags å¯¹è±¡**:
```lua
function Tab(msg)
    local inputs = {}
    for _, o in ipairs(msg.Tags) do
        if not inputs[o.name] then
            inputs[o.name] = o.value
        end
    end
    return inputs
end
```

### nonExtractableTags åˆ—è¡¨

```lua
nonExtractableTags = {
    'Data-Protocol', 'Variant', 'From-Process', 'From-Module', 'Type',
    'From', 'Owner', 'Anchor', 'Target', 'Data', 'Tags'
}
```

**å…³é”®å‘ç°**: `'Action'` **ä¸åœ¨** `nonExtractableTags` åˆ—è¡¨ä¸­ï¼

## ğŸ”„ ä¸¤ç§æ„é€ æ–¹å¼çš„å®Œæ•´å¤„ç†è¿‡ç¨‹

### å‘é€ç«¯å¤„ç†

#### æ–¹å¼1: Send({Target=ao.id, Action="XXX"})
1. **æ ¹éƒ¨å±æ€§ â†’ Tags æ•°ç»„**: AO send() å°† `Action` å±æ€§è½¬æ¢ä¸º Tag
2. å‘é€çš„æ¶ˆæ¯ Tags æ•°ç»„: `[{name="Action", value="XXX"}, ...]`
3. **æ³¨æ„**: å‘é€æ—¶ `msg.Action` ä»ç„¶å­˜åœ¨ï¼Œä½†ä¸ä¼šåŒæ­¥åˆ° Tags æ•°ç»„

#### æ–¹å¼2: Send({Target=ao.id, Tags={Action="XXX"}})
1. **Tags å¯¹è±¡ â†’ Tags æ•°ç»„**: AO send() å°†å¯¹è±¡æ ¼å¼è½¬æ¢ä¸ºæ•°ç»„æ ¼å¼
2. å‘é€çš„æ¶ˆæ¯ Tags æ•°ç»„: `[{name="Action", value="XXX"}, ...]`
3. **æ³¨æ„**: å‘é€æ—¶ `msg.Tags.Action` ä»ç„¶å­˜åœ¨ï¼Œä½†ä¸ä¼šè®¾ç½® `msg.Action`

### æ¥æ”¶ç«¯å¤„ç†

#### ä¸¤ç§æ–¹å¼æœ€ç»ˆéƒ½ç»è¿‡ç›¸åŒçš„æ ‡å‡†åŒ–è¿‡ç¨‹:
1. **Tags æ•°ç»„ â†’ æ¶ˆæ¯æ ¹éƒ¨**: `ao.normalize()` æ‰§è¡Œ `msg["Action"] = "XXX"`
2. **Tags æ•°ç»„ â†’ Tags å¯¹è±¡**: `Tab()` åˆ›å»º `msg.Tags = {Action = "XXX"}`
3. **æœ€ç»ˆç»“æœ**: `msg.Action = "XXX"` å’Œ `msg.Tags.Action = "XXX"` âœ…

#### å…³é”®æ´å¯Ÿ
- **å‘é€ç«¯ä¸åšåŒå‘åŒæ­¥**: åªæœ‰æ„é€ æ—¶çš„æ•°æ®è½¬æ¢ï¼Œæ²¡æœ‰åå‘åŒæ­¥
- **æ¥æ”¶ç«¯æ‰å»ºç«‹å®Œæ•´ç»“æ„**: é€šè¿‡ `ao.normalize()` å’Œ `Tab()` åˆ›å»ºæ‰€æœ‰è®¿é—®æ–¹å¼
- **ç½‘ç»œä¼ è¾“åªä¾èµ– Tags æ•°ç»„**: æ ¹éƒ¨å±æ€§åœ¨ä¼ è¾“å‰å°±è¢«è½¬æ¢ä¸º Tags

## ğŸ¯ æœ€ç»ˆæ•ˆæœ

ä¸¤ç§å†™æ³•åœ¨**æ¥æ”¶ç«¯**éƒ½äº§ç”Ÿå®Œå…¨ç›¸åŒçš„æ¶ˆæ¯ç»“æ„ï¼š
- `msg.Action = "XXX"` (é€šè¿‡ `ao.normalize()` è®¾ç½®)
- `msg.Tags.Action = "XXX"` (é€šè¿‡ `Tab()` è®¾ç½®)

**Handler åŒ¹é…å®Œå…¨ä¸€è‡´**:
```lua
Handlers.add(
    "handler",
    Handlers.utils.hasMatchingTag("Action", "XXX"),  -- å¯¹ä¸¤ç§æ–¹å¼éƒ½æœ‰æ•ˆ
    handler_function
)
```

**å‘é€ç«¯å·®å¼‚**:
- æ–¹å¼1: `msg.Action` å­˜åœ¨ï¼Œä½†æœªåŒæ­¥åˆ° Tags
- æ–¹å¼2: `msg.Tags.Action` å­˜åœ¨ï¼Œä½† `msg.Action` ä¸å­˜åœ¨
- ä½†è¿™ä¸å½±å“æœ€ç»ˆçš„æ¥æ”¶ç«¯ç»“æ„å’Œ Handler åŒ¹é…

## ğŸ”„ æ¶ˆæ¯åŒæ­¥æœºåˆ¶è¯¦è§£

AO å®ç°äº†ä»å‘é€åˆ°æ¥æ”¶çš„å®Œæ•´æ¶ˆæ¯æ ‡å‡†åŒ–æµç¨‹ï¼š

### å‘é€ç«¯ï¼šæ„é€ æ ‡å‡†åŒ–ï¼ˆå•å‘åŒæ­¥ï¼‰

| æ–¹å‘       | é˜¶æ®µ                  | å®ç°å‡½æ•°    | ä½œç”¨                               |
| ---------- | --------------------- | ----------- | ---------------------------------- |
| **å‘é€ç«¯** | æ ¹éƒ¨å±æ€§ â†’ Tags æ•°ç»„  | `ao.send()` | å°†æ¶ˆæ¯æ ¹éƒ¨å±æ€§è½¬æ¢ä¸ºæ ‡å‡† Tags æ ¼å¼ |
| **å‘é€ç«¯** | Tags å¯¹è±¡ â†’ Tags æ•°ç»„ | `ao.send()` | ç»Ÿä¸€ä¸åŒ Tags è¾“å…¥æ ¼å¼             |

**æ³¨æ„**: å‘é€ç«¯**ä¸åš** Tags æ•°ç»„ â†’ æ ¹éƒ¨å±æ€§çš„åŒæ­¥ï¼

### æ¥æ”¶ç«¯ï¼šè§£ææ ‡å‡†åŒ–ï¼ˆå•å‘åŒæ­¥ï¼‰

| æ–¹å‘       | é˜¶æ®µ                  | å®ç°å‡½æ•°         | ä½œç”¨                       |
| ---------- | --------------------- | ---------------- | -------------------------- |
| **æ¥æ”¶ç«¯** | Tags æ•°ç»„ â†’ æ¶ˆæ¯æ ¹éƒ¨  | `ao.normalize()` | æå–å…è®¸çš„ Tags åˆ°æ¶ˆæ¯å±æ€§ |
| **æ¥æ”¶ç«¯** | Tags æ•°ç»„ â†’ Tags å¯¹è±¡ | `Tab()`          | åˆ›å»ºä¾¿äºè®¿é—®çš„ Tags å¯¹è±¡   |

### å®Œæ•´æµç¨‹è¯´æ˜

1. **å‘é€ç«¯æ ‡å‡†åŒ–**: å°†å„ç§è¾“å…¥æ ¼å¼ç»Ÿä¸€ä¸º Tags æ•°ç»„æ ¼å¼
2. **ç½‘ç»œä¼ è¾“**: Tags æ•°ç»„æ˜¯æƒå¨çš„ä¼ è¾“æ ¼å¼
3. **æ¥æ”¶ç«¯æ ‡å‡†åŒ–**: å°† Tags æ•°ç»„è½¬æ¢ä¸ºä¾¿äºè®¿é—®çš„æ¶ˆæ¯ç»“æ„

è¿™ç§è®¾è®¡ç¡®ä¿äº†ï¼š
- **å‘é€çµæ´»æ€§**: æ”¯æŒå¤šç§æ¶ˆæ¯æ„é€ æ–¹å¼
- **ä¼ è¾“ä¸€è‡´æ€§**: Tags æ•°ç»„æ˜¯æ ‡å‡†ä¼ è¾“æ ¼å¼
- **æ¥æ”¶ä¸€è‡´æ€§**: æ— è®ºè¾“å…¥æ ¼å¼ï¼Œæœ€ç»ˆæ¶ˆæ¯ç»“æ„ç›¸åŒ
- **Handler å…¼å®¹æ€§**: åŒ¹é…é€»è¾‘å¯¹æ‰€æœ‰ç­‰ä»·æ ¼å¼éƒ½æœ‰æ•ˆ

## ğŸ“Š éªŒè¯ä¾æ®

1. **æºç éªŒè¯**: AO/AOS ä»£ç åº“å®Œæ•´å¤„ç†é“¾åˆ†æ
2. **åˆ—è¡¨æ£€æŸ¥**: `nonExtractableTags` ä¸åŒ…å« `'Action'`
3. **æµç¨‹è¿½è¸ª**: ä»å‘é€åˆ°æ¥æ”¶çš„ç«¯åˆ°ç«¯å¤„ç†é“¾
4. **Handler éªŒè¯**: `handlers-utils.lua` åŒ¹é…é€»è¾‘æµ‹è¯•

## ğŸ’¡ å®è·µæ„ä¹‰

1. **ä»£ç çµæ´»æ€§**: å¼€å‘è€…å¯ä»¥ä½¿ç”¨ä»»ä¸€ç§æ„é€ æ–¹å¼
2. **å‘åå…¼å®¹**: ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹
3. **ä¸€è‡´æ€§ä¿è¯**: AO ç³»ç»Ÿç¡®ä¿æ‰€æœ‰æ–¹å¼è¡Œä¸ºä¸€è‡´
4. **è°ƒè¯•ä¾¿åˆ©**: å¤šç§è®¿é—®æ–¹å¼ (`msg.Action` æˆ– `msg.Tags.Action`)

## âš ï¸ æ³¨æ„äº‹é¡¹

- è¯¥ç­‰ä»·æ€§ä»…é€‚ç”¨äºä¸åœ¨ `nonExtractableTags` åˆ—è¡¨ä¸­çš„ Tag åç§°
- `Action` Tag ä¼šè¢«è‡ªåŠ¨æå–åˆ°æ¶ˆæ¯æ ¹éƒ¨å±æ€§
- Handler åº”ä½¿ç”¨ `Handlers.utils.hasMatchingTag()` è¿›è¡ŒåŒ¹é…
- Tags æ•°ç»„æ˜¯æƒå¨æ ¼å¼ï¼Œå¯¹è±¡æ ¼å¼æ˜¯æ´¾ç”Ÿæ ¼å¼

## ğŸ“ ç»“è®º

é€šè¿‡æ·±å…¥æºç åˆ†æï¼Œå®Œå…¨è¯å®äº†ç»éªŒåˆ¤æ–­ï¼šä¸¤ç§æ¶ˆæ¯æ„é€ æ–¹å¼åœ¨ AO ç³»ç»Ÿä¸­ç¡®å®å®Œå…¨ç­‰ä»·ã€‚è¿™ä¸ªåŒå‘åŒæ­¥æœºåˆ¶æ˜¯ AO æ¶ˆæ¯ç³»ç»Ÿè®¾è®¡çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ï¼Œç¡®ä¿äº†å¼€å‘ä½“éªŒçš„ä¸€è‡´æ€§å’Œçµæ´»æ€§ã€‚
